            <!DOCTYPE html>
            <html>
            <head>
                <title>Creator Network Analytics</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
                <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
                <style>
                    /* Root variables */
                    :root {
                        --font-primary: 'Libre Franklin', sans-serif;
                        --color-background: #f9f7f4;
                        --color-text: #1E1E1E;
                        --color-border: #dcd4c4;
                        --color-background-darker: #f6f2ea;
                    }

                    /* Base styles */
                    * {
                        font-family: var(--font-primary);
                    }

                    body {
                        background-color: var(--color-background);
                        color: var(--color-text);
                        line-height: 1.5;
                    }

                    /* Typography updates */
                    h1, h2, h3, .display-4, p, span, label, input, select, button {
                        font-family: var(--font-primary) !important;
                    }

                    h2 {
                        font-weight: 800;
                        font-size: 1.4rem;
                    }

                    /* Form control updates */
                    .form-select, .form-control {
                        width: 100%;
                        padding: 12px 16px;
                        border: 1px solid var(--color-border);
                        border-radius: 8px;
                        height: 65px;
                        font-size: 16px;
                        background: #FFFFFF;
                    }

                    .form-select:focus, .form-control:focus {
                        outline: none;
                        border-color: #007AFF;
                        box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
                    }

                    /* Card updates */
                    .card {
                        background: white;
                        padding: 32px !important;
                        border: none;
                        border-radius: 5px;
                    }

                    .card-body {
                        padding: 0;
                    }

                    /* Table updates */
                    .table {
                        width: 100%;
                        margin-bottom: 0;
                    }

                    .table th {
                        font-weight: 600;
                        color: var(--color-text);
                        border-bottom: 2px solid var(--color-border);
                        padding: 16px;
                    }

                    .table td {
                        vertical-align: middle;
                        border-bottom: 1px solid var(--color-border);
                        padding: 16px;
                    }

                    /* Button updates */
                    .btn {
                        font-size: 0.9rem !important;
                        font-weight: 500;
                        padding: 8px 16px;
                        border-radius: 8px;
                    }

                    .btn-outline-primary {
                        border-color: var(--color-border);
                        color: var(--color-text);
                    }

                    .btn-outline-primary:hover {
                        background-color: var(--color-background);
                        border-color: var(--color-text);
                        color: var(--color-text);
                    }

                    /* Trends panel updates */
                    .trends-panel {
                        background: var(--color-background);
                        padding: 32px !important;
                    }

                    .metrics-summary {
                        background: white;
                        border-radius: 5px;
                        padding: 24px;
                    }

                    /* Growth items styling */
                    .growth-item {
                        padding: 12px;
                        border-radius: 8px;
                        margin-bottom: 4px;  /* Reduced from 8px */
                    }

                    .growth-item .partner-name {
                        font-size: 1rem;
                        font-weight: 500;
                        color: var(--color-text);
                    }

                    .growth-value {
                        font-size: 0.9rem;
                        font-weight: 600;
                    }

                    .period-label {
                        font-size: 0.9rem;
                        color: #666;
                        margin-left: 4px;
                    }

                    .growth-item.positive {
                        background: #edfff1;
                    }

                    .growth-item.negative {
                        background: #fff1f1;
                    }

                    /* Modal updates */
                    .modal-content {
                        background: var(--color-background);
                        border: none;
                        border-radius: 12px;
                    }

                    .modal-header {
                        border-bottom: 1px solid var(--color-border);
                        padding: 24px 32px;
                    }

                    .modal-body {
                        padding: 32px;
                    }

                    .modal-footer {
                        border-top: 1px solid var(--color-border);
                        padding: 24px 32px;
                    }

                    .positive { color: green; }
                    .negative { color: red; }
                    .table-container { margin-bottom: 2rem; }
                    .trends-panel {
                        position: fixed;
                        right: -500px;
                        top: 0;
                        width: 500px;
                        height: 100vh;
                        background: white;
                        box-shadow: -20px 1px 120px 30px rgba(0, 0, 0, 0.1);
                        transition: right 0.3s ease;
                        z-index: 1050;
                        padding: 20px;
                        overflow-y: auto;
                    }
                    .text-muted {
                font-size: 14px;
                font-weight: 100;
                line-height: 1.7em;
                color: #181919 !important;
            }
                    .trends-panel.active { right: 0; }
                    .chart-container {
                        height: 300px !important;
                        position: relative;
                        margin-bottom: 40px;
                    }
                    
                    .chart-container canvas {
                        max-height: 100%;
                    }
                    
                    .chart-container h4 {
                        margin-bottom: 20px;
                    }
                    
                    .table-row-clickable:hover {
                        background-color: var(--color-background-darker) !important;
                        cursor: pointer;
                    }
                    .metrics-summary {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }
                    
                    .metric {
                        margin-bottom: 10px;
                    }
                    
                    .metric label {
                        display: block;
                        font-size: 0.9em;
                        color: #666;
                    }
                    
                    .metric span {
                        font-size: 1.2em;
                        font-weight: bold;
                    }
                    .partnership-trends {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        margin-top: 20px;
                    }

                    .current-period .stats {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                        margin: 15px 0;
                    }

                    .relationship-summary {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        margin: 20px 0;
                    }

                    .rounded-circle {
                        background-color: #e0d4be !important;
                    }

                    .trend-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                    }

                    .trend-direction {
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 0.9em;
                    }

                    .trend-direction.improving {
                        background: #e6ffe6;
                        color: #006600;
                    }

                    .trend-direction.declining {
                        background: #ffe6e6;
                        color: #660000;
                    }

                    /* Ensure tooltips appear above the panel */
                    .tooltip {
                        z-index: 1060 !important;
                    }
                    
                    /* Style the partner name header */
                    #partnerNameHeader {
                        font-size: 1.5rem;
                        margin: 0;
                        padding: 0;
                    }

                    .partner-name {
                        font-size: 1.75rem;
                        font-weight: 600;
                        margin: 0;
                        padding: 0;
                    }

                    .trends-panel {
                        padding: 20px;
                    }

                    /* Ensure tooltips are visible */
                    .tooltip {
                        z-index: 9999 !important;
                    }

                    .trends-panel h1 {
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                    }
                    
                    .trends-panel .partner-name {
                        font-size: 1.5rem;
                        color: #666;
                        margin-top: 0;
                    }

                    .panel-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 2rem;
                    }

                    .title-section h1 {
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                    }

                    .title-section .partner-name {
                        font-size: 2.3rem;
                        font-family: 'Anton', sans-serif !important;
                        font-weight: bold;
                        line-height: 1.1;
                        color: #1e1e1e;
                        margin-top: 0;
                        text-transform: uppercase;
                    }

                    /* Style the info icons */
                    .bi-info-circle {
                        font-size: 0.9em;
                        color: #6c757d;
                        cursor: help;
                        margin-left: 4px;
                    }

                    .card-body h6 {
                        font-size: 0.9rem;
                        color: #666;
                        margin-bottom: 1rem;
                    }
                    
                    .growth-item {
                        margin-bottom: 0.5rem;
                    }
                    
                    .growth-item .partner-name {
                        font-size: 0.85rem;
                        color: #333;
                        margin-bottom: 0.1rem;
                    }
                    
                    .growth-item .growth-value {
                        font-size: 0.8rem;
                        font-weight: 500;
                    }
                    
                    .growth-value.positive {
                        color: #28a745;
                    }
                    
                    .growth-value.negative {
                        color: #dc3545;
                    }
                    .growth-value-container {
                        display: flex;
                        align-items: baseline;
                        gap: 4px;
                    }
                    
                    .period-label {
                        font-size: 0.7rem;
                        color: #666;
                        font-weight: normal;
                    }
                    
                    .show-more-button {
                        margin: 1rem 0 3rem 0;
                        color: #9a8a71;
                        text-decoration: none;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        background-color: #f1ede6;
                        padding: 1rem 1rem;
                        border: #9a8a71;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }
                    
                    .show-more-button:hover {
                        background-color: #f8f9fa;
                        color: #495057;
                    }
                    
                    .show-more-button i {
                        transition: transform 0.2s ease;
                    }
                    
                    .show-more-button[aria-expanded="true"] i {
                        transform: rotate(180deg);
                    }
                    
                    /* Add more bottom margin to the container */
                    .container {
                        margin-bottom: 5rem;
                    }

                    /* Add this to your existing CSS styles section */
                    .table th:nth-child(4),
                    .table td:nth-child(4) {
                        background-color: var(--color-background-darker);
                    }

                    /* Update the form label styling */
                    .form-label, 
                    label {
                        margin-bottom: 5px;
                        display: block;
                    }

                    /* Update table cell alignment */
                    .table td:first-child {
                        text-align: left;  /* Keep partner name left-aligned */
                    }

                    .table td:not(:first-child),
                    .table th:not(:first-child) {
                        text-align: center;  /* Center all other columns */
                    }

                    /* Keep the pill styling centered within the cell */
                    .table td .positive,
                    .table td .negative {
                        padding: 4px 12px;
                        border-radius: 999px;
                        display: inline-block;
                    }

                    .table td .positive {
                        color: #0a7d2c;
                        background-color: #e6ffe6;
                    }

                    .table td .negative {
                        color: #d32f2f;
                        background-color: #ffe6e6;
                    }

                    /* Modal updates to match main page */
                    .modal-content {
                        background: var(--color-background);
                        border: none;
                        border-radius: 12px;
                    }

                    .modal-header {
                        border-bottom: 1px solid var(--color-border);
                        padding: 24px 32px;
                    }

                    .modal-body {
                        padding: 32px;
                    }

                    .modal-footer {
                        border-top: 1px solid var(--color-border);
                        padding: 24px 32px;
                    }

                    /* Form control updates to match main page */
                    .modal .form-select, 
                    .modal .form-control {
                        width: 100%;
                        padding: 12px 16px;
                        border: 1px solid var(--color-border);
                        border-radius: 8px;
                        height: 65px;
                        font-size: 16px;
                        background: #FFFFFF;
                    }

                    .modal .form-select:focus, 
                    .modal .form-control:focus {
                        outline: none;
                        border-color: #007AFF;
                        box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
                    }

                    /* Typography updates */
                    .modal-title {
                        font-weight: 800;
                        font-size: 1.4rem;
                    }

                    .modal label {
                        font-weight: 500;
                        margin-bottom: 8px;
                    }

                    /* Button updates to match main page */
                    .modal .btn {
                        font-size: 0.9rem !important;
                        font-weight: 500;
                        padding: 8px 16px;
                        border-radius: 8px;
                    }

                    .modal .btn-outline-primary {
                        border-color: var(--color-border);
                        color: var(--color-text);
                    }

                    .modal .btn-outline-primary:hover {
                        background-color: var(--color-background);
                        border-color: var(--color-text);
                        color: var(--color-text);
                    }

                    /* Modal header typography */
                    .modal-header {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }

                    .modal-header h6 {
                        font-size: 0.9rem;
                        color: #666;
                        font-weight: 500;
                        margin: 0;
                    }

                    .modal-header h1 {
                        font-size: 2rem;
                        font-weight: 800;
                        margin: 0;
                    }

                    /* Section headers */
                    .modal-body h5 {
                        font-size: 1.1rem;
                        font-weight: 700;
                        margin-bottom: 1rem;
                        color: var(--color-text);
                    }

                    .trend-metrics {
                        margin-top: 3.5rem;
                    }

                    .metrics-summary {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }

                    .metric {
                        margin-bottom: 10px;
                    }

                    .metric label {
                        display: block;
                        font-size: 0.9em;
                        color: #666;
                    }

                    .metric span {
                        font-size: 1.2em;
                        font-weight: bold;
                    }

                    /* Add this grid layout */
                    .current-period .stats,
                    .trend-metrics .metrics-summary {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                        margin: 15px 0;
                    }

                    .table-number {
                        font-size: 0.9rem;  /* or 14px */
                    }

                    /* Update title sizes */
                    .section-title {
                        font-size: 1.2rem;  /* Smaller than default h2 */
                        font-weight: 700;
                        margin-bottom: 1rem;
                    }

                    /* Add more spacing between sections */
                    .metrics-container {
                        margin-bottom: 3.5rem;  /* Increased to 3.5rem */
                    }

                    /* Adjust card spacing */
                    .card {
                        margin-bottom: 1.5rem;  /* Add space between cards */
                    }

                    /* Adjust metric label sizes */
                    .metric-label {
                        font-size: 0.9rem;
                        color: var(--color-text);
                        opacity: 0.7;
                    }

                    .metrics-container {
                        margin-bottom: 3.5rem;
                    }

                    .metrics-container h2 {
                        font-size: 1.2rem;
                        font-weight: 700;
                        margin-bottom: 1rem;
                        color: var(--color-text);
                    }

                    .metrics-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 24px;
                        background: #f9f9f9;
                        padding: 24px;
                        border-radius: 8px;
                    }

                    .metric-item {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }

                    .metric-label {
                        font-size: 0.9rem;
                        color: #666;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }

                    .metric-value {
                        font-size: 1rem;
                        font-weight: 700;
                        color: var(--color-text);
                    }

                    .bi-info-circle {
                        font-size: 0.8rem;
                        color: #999;
                        cursor: help;
                    }

                    .network-graph-container {
                        width: 100%;
                        height: 600px;
                        background: white;
                        border-radius: 8px;
                        overflow: hidden;
                    }

                    .network-graph-container svg {
                        width: 100%;
                        height: 100%;
                    }

                    .btn-close {
                        position: absolute;
                        right: 20px;
                        top: 20px;
                        opacity: 0.5;
                        transition: opacity 0.2s;
                    }

                    .btn-close:hover {
                        opacity: 1;
                    }

                    .panel-header {
                        position: relative;
                        padding-right: 40px;
                    }

                    .partner-item {
                        padding: 8px;
                        border-radius: 4px;
                        margin-bottom: 8px;
                    }

                    .partner-item:hover {
                        background-color: var(--color-background-darker);
                    }

                    .value {
                        margin-left: 8px;
                        font-weight: 600;
                    }

                    .value.positive {
                        color: #28a745;
                    }

                    .value.negative {
                        color: #dc3545;
                    }

                    .period {
                        color: #666;
                        font-size: 0.9em;
                        margin-left: 8px;
                    }

                    /* Add these styles in the existing <style> section */
                    .partnership-carousel {
                        overflow: hidden;
                        position: relative;
                        margin: 0 -15px;  /* Compensate for column padding */
                    }

                    .partnership-slide {
                        display: flex;
                        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                        padding: 0 15px;
                        width: 100%;
                    }

                    .partnership-nav-container {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        display: flex;
                        gap: 8px;
                        z-index: 10;
                    }

                    .partnership-nav {
                        width: 36px;
                        height: 36px;
                        padding: 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        background-color: #007bff;
                        border: none;
                        color: white;
                        transition: background-color 0.2s ease;
                    }

                    .partnership-nav:hover:not(:disabled) {
                        background-color: #0056b3;
                    }

                    .partnership-nav:disabled {
                        background-color: #e9ecef;
                        color: #6c757d;
                        cursor: not-allowed;
                    }

                    .partnership-indicators {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                        justify-content: center;
                        margin-top: 20px;
                    }

                    .indicator {
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background-color: #dee2e6;
                        cursor: pointer;
                        transition: background-color 0.2s ease;
                    }

                    .indicator.active {
                        background-color: #007bff;
                    }

                    /* Update the partnership health card styling */
                    .partnership-health-card {
                        display: flex;
                        align-items: center;
                        gap: 2rem;
                        padding: 1rem 1.5rem;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 1.5rem;
                    }

                    .health-metric {
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }

                    .health-metric-label {
                        color: #666;
                        font-size: 0.9rem;
                    }

                    .health-metric-value {
                        font-weight: 600;
                        font-size: 1.2rem;
                    }

                    .health-metric-value.positive {
                        color: #28a745;
                    }

                    .health-metric-value.negative {
                        color: #dc3545;
                    }

                    /* Update the button styles */
                    .partnership-nav {
                        background-color: #007bff !important;
                        color: white !important;
                    }

                    .partnership-nav:hover:not(:disabled) {
                        background-color: #0056b3 !important;
                    }

                    /* Update the search and manual referrals container */
                    .search-container {
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin-bottom: 1.5rem;
                    }

                    /* Update the HTML structure for the partnership health section */
                    .partnership-health-card {
                        display: flex;
                        align-items: center;
                        gap: 2rem;
                        padding: 1rem 1.5rem;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 1.5rem;
                    }

                    /* Add these styles to your existing style section */
                    .sortable {
                        cursor: pointer;
                        position: relative;
                    }

                    .sortable:after {
                        content: '\2195';  /* Unicode for ↕ */
                        font-size: 12px;
                        color: #999;
                        margin-left: 5px;
                    }

                    .sortable.asc:after {
                        content: '\2191';  /* Unicode for ↑ */
                        color: #007bff;
                    }

                    .sortable.desc:after {
                        content: '\2193';  /* Unicode for ↓ */
                        color: #007bff;
                    }

                    /* Form control styles */
                    .form-control {
                        height: 36px;
                        padding: 8px 16px;
                        border: 1px solid var(--color-border);
                        border-radius: 8px;
                        font-size: 14px;
                        background: #FFFFFF;
                        line-height: 20px;
                    }

                    /* Search and button container styles */
                    .d-flex.justify-content-between .form-control {
                        height: 38px;
                        width: 250px;
                        padding: 0.375rem 0.75rem;
                    }

                    .d-flex.justify-content-between .btn {
                        height: 38px;
                        padding: 0.375rem 0.75rem;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                    }

                    /* Footer styles */
                    .footer {
                        width: 100%;
                        background: white;
                        padding: 12px 24px;
                        border-top: 1px solid var(--color-border);
                        text-align: center;
                        font-size: 0.9rem;
                        margin-top: 2rem;
                    }

                    .footer a {
                        color: var(--color-text);
                        text-decoration: none;
                        opacity: 0.7;
                        transition: opacity 0.2s ease;
                    }

                    .footer a:hover {
                        opacity: 1;
                    }
                </style>
                <!-- Add this in the head section with other scripts -->
                <script src="https://d3js.org/d3.v7.min.js"></script>
            </head>
            <body>
                <div class="container mt-4">
                    <h2 class="mb-4">Creator Network Analytics</h2>
                    
                    <!-- Add Client and Date Selectors -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientSelect">Client</label>
                                <select class="form-select" id="clientSelect">
                                    <option value="all">All Clients</option>
                                    <option value="Demo Client">Demo Client</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateRangeSelect">Date Range</label>
                                <select class="form-select" id="dateRangeSelect">
                                    <option value="1">24 hours</option>
                                    <option value="2">48 hours</option>
                                    <option value="7">7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30" selected>30 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Add this after the date selector, before the table -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Partnership Health</h5>
                                    <div class="d-flex justify-content-between">
                                        <div class="metric">
                                            <label>Improving</label>
                                            <span class="value positive">1</span>
                                        </div>
                                        <div class="metric">
                                            <label>Declining</label>
                                            <span class="value negative">3</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Fastest Growing</h6>
                                            <div class="fastest-growing">
                                                <!-- Growing partnerships will go here -->
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Fastest Declining</h6>
                                            <div class="fastest-declining">
                                                <!-- Declining partnerships will go here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="masterDashboard" class="mb-5">
                        <div class="row">
                            <!-- Overall Health Card -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Network Health</h5>
                                        <div class="d-flex justify-content-between">
                                            <div class="metric">
                                                <label>Total Active Partnerships</label>
                                                <span id="totalPartnerships" class="value">0</span>
                                            </div>
                                            <div class="metric">
                                                <label>Troubled Partnerships</label>
                                                <span id="troubledPartnerships" class="value negative">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Most Imbalanced Card -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Most Imbalanced Partnerships</h5>
                                        <div id="topImbalances">
                                            <!-- Will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inactive Partnerships Card -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Recently Inactive</h5>
                                        <div id="recentlyInactive">
                                            <!-- Will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Network Graph -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <h2>Network Graph</h2>
                                    <div id="networkGraph" class="network-graph-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="defaultDashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="mb-0">Largest Referral Imbalances</h3>
                            <div class="d-flex align-items-center gap-3">
                                <input type="text" 
                                    class="form-control form-control-sm" 
                                    placeholder="Search partners..." 
                                    id="partnerSearch"
                                    style="width: 250px; height: 38px;"
                                    oninput="filterPartners(this.value)">
                                <button class="btn btn-outline-primary d-inline-flex align-items-center gap-2" 
                                        style="height: 38px;"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#manualEntryModal">
                                    <i class="bi bi-plus-circle"></i> Add Manual Referrals
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('partner')">Partner</th>
                                        <th class="sortable" onclick="sortTable('received')">Received</th>
                                        <th class="sortable" onclick="sortTable('sent')">Sent</th>
                                        <th class="sortable desc" onclick="sortTable('balance')">Balance</th>
                                        <th class="sortable" onclick="sortTable('allTimeBalance')">All-Time Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="activePartners">
                                    <!-- Active partners will go here -->
                                </tbody>
                                
                                <tbody id="inactivePartnersSection" class="collapse">
                                    <!-- Inactive partners will go here -->
                                </tbody>
                            </table>
                            
                            <button class="show-more-button" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#inactivePartnersSection" 
                                    aria-expanded="false">
                                <span class="button-text">Show inactive partners</span>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trends Panel -->
                <div id="trendsPanel" class="trends-panel">
                    <div class="panel-header">
                        <div class="title-section">
                            <h6>Partnership Trends</h6>
                            <h1 id="partnerName" class="partner-name"></h1>
                        </div>
                        <button type="button" class="btn-close" onclick="closeTrendsPanel()"></button>
                    </div>
                    
                    <div class="metrics-container">
                        <h2>Current Period <span class="period-label" id="period-label"></span></h2>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Received</div>
                                <div class="metric-value" id="receivedMetric">5</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Sent</div>
                                <div class="metric-value" id="sentMetric">1,884</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Balance</div>
                                <div class="metric-value" id="balanceMetric">-1,879</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metrics-container">
                        <h2>Growth Metrics</h2>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">
                                    Daily Change 
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Average daily change in referrals"></i>
                                </div>
                                <div class="metric-value" id="dailyChangeMetric">944.5</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">
                                    Growth Rate 
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Percentage growth over period"></i>
                                </div>
                                <div class="metric-value" id="growthRateMetric">166.6%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">
                                    Trend 
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Overall trend direction"></i>
                                </div>
                                <div class="metric-value" id="trendMetric">Declining</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metrics-container">
                        <h2>Historical Trend</h2>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="metrics-container">
                        <h2>Conversion Rate</h2>
                        <div class="chart-container">
                            <canvas id="conversionRateChart"></canvas>
                        </div>
                    </div>

                    <div class="metrics-container">
                        <h2>Daily Changes</h2>
                        <div class="chart-container">
                            <canvas id="dailyChangesChart"></canvas>
                        </div>
                    </div>
                </div>

                <script>
                    // Add this at the very top of your JavaScript section
                    const API_BASE_URL = window.location.hostname === 'localhost'
                        ? 'http://localhost:5001'
                        : 'https://referral-tracker-8dea3f9d92b7.herokuapp.com';
                    
                    console.log('Current hostname:', window.location.hostname);
                    console.log('API_BASE_URL set to:', API_BASE_URL);

                    // 1. Global variables (declare only once)
                    let exchangeChart = null;
                    let currentSort = { column: 'balance', direction: 'desc' };
                    let tableData = [];
                    let avatar_mapping = {};
                    let trendChart = null;  // Global reference to chart
                    let dailyChangesChart = null; // Add this as a global variable at the top with other declarations
                    let conversionRateChart = null;  // Add this variable

                    // Define populateClientDropdown function
                    async function populateClientDropdown() {
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/available-accounts`);
                            const data = await response.json();
                            
                            if (data.success) {
                                const clientSelect = document.getElementById('clientSelect');
                                clientSelect.innerHTML = '<option value="All Clients">All Clients</option>';
                                
                                // Only add enabled accounts to the dropdown
                                data.enabled_accounts.forEach(account => {
                                    const option = document.createElement('option');
                                    option.value = account;
                                    option.textContent = account;
                                    clientSelect.appendChild(option);
                                });
                            } else {
                                console.error('Failed to get accounts:', data.error);
                                alert('Error loading accounts: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error loading accounts:', error);
                            alert('Error loading accounts: ' + error.message);
                        }
                    }

                    // 2. DOM Ready handler (single one)
                    document.addEventListener('DOMContentLoaded', async function() {
                        console.log('DOMContentLoaded event fired');
                        try {
                            // Load avatar mapping
                            const avatarResponse = await fetch(`${API_BASE_URL}/data/avatars/avatar_mapping.json`);
                            avatar_mapping = await avatarResponse.json();
                            
                            // Populate client dropdown first
                            console.log('Calling populateClientDropdown');
                            await populateClientDropdown();

                            // Initialize master dashboard view
                            toggleDashboardView('master');
                            await updateMasterDashboard();
                            
                            // Initialize tooltips
                            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                            if (tooltips.length > 0 && typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                                tooltips.forEach(el => new bootstrap.Tooltip(el));
                            }
                        } catch (error) {
                            console.error('Error during initialization:', error);
                        }
                    });

                    // 3. Format number function
                    function formatNumber(num) {
                        if (num === null || num === undefined) return '0';
                        return num.toLocaleString();
                    }
                    
                    // 4. Show trends panel function
                    function showTrendsPanel(partner, account) {
                        console.log('Showing trends panel for:', partner, 'Account:', account);
                        
                        document.getElementById('partnerName').textContent = partner;
                        const panel = document.getElementById('trendsPanel');
                        panel.classList.add('active');
                        
                        // Get date range
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        // Build URL with query parameters
                        const params = new URLSearchParams({
                            account: account,
                            partner: partner,
                            start: start.toISOString().split('T')[0],
                            end: end.toISOString().split('T')[0]
                        });
                        
                        const url = `${API_BASE_URL}/api/partnership-trends?${params.toString()}`;
                        
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (!data.historical_data) {
                                    throw new Error('No historical data received');
                                }
                                
                                // Update the main trend chart
                                const trendCtx = document.getElementById('trendChart').getContext('2d');
                                if (trendChart instanceof Chart) {
                                    trendChart.destroy();
                                }
                                trendChart = new Chart(trendCtx, {
                                    type: 'line',
                                    data: {
                                        labels: data.historical_data.dates,
                                        datasets: [{
                                            label: 'Received',
                                            data: data.historical_data.received,
                                            borderColor: 'rgb(75, 192, 192)',
                                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                            tension: 0.1,
                                            fill: true
                                        }, {
                                            label: 'Sent',
                                            data: data.historical_data.sent,
                                            borderColor: 'rgb(255, 99, 132)',
                                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                            tension: 0.1,
                                            fill: true
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                ticks: {
                                                    callback: function(value) {
                                                        return value.toLocaleString();
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });

                                // Render conversion rate chart
                                const conversionCtx = document.getElementById('conversionRateChart').getContext('2d');
                                if (conversionRateChart instanceof Chart) {
                                    conversionRateChart.destroy();
                                }

                                // Check if we have valid conversion rate data
                                if (data.historical_data.conversion_rates) {
                                    // Filter out null values and prepare data
                                    const conversionData = data.historical_data.conversion_rates.map((rate, index) => ({
                                        x: data.historical_data.dates[index],
                                        y: rate !== null ? rate * 100 : null  // Convert back to percentage
                                    })).filter(point => point.y !== null);

                                    conversionRateChart = new Chart(conversionCtx, {
                                        type: 'line',
                                        data: {
                                            datasets: [{
                                                label: 'Conversion Rate',
                                                data: conversionData,
                                                borderColor: '#9333ea',
                                                backgroundColor: '#9333ea',
                                                tension: 0.4
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: {
                                                intersect: false,
                                                mode: 'index'
                                            },
                                            plugins: {
                                                legend: {
                                                    position: 'top'
                                                },
                                                tooltip: {
                                                    callbacks: {
                                                        label: context => `${context.parsed.y.toFixed(2)}%`
                                                    }
                                                }
                                            },
                                            scales: {
                                                y: {
                                                    beginAtZero: true,
                                                    max: 100,  // Set max to 100%
                                                    ticks: {
                                                        callback: value => value.toFixed(1) + '%'
                                                    }
                                                }
                                            }
                                        }
                                    });
                                } else {
                                    // If no conversion rate data, show a message
                                    const container = conversionCtx.canvas.parentElement;
                                    container.innerHTML = `
                                        <div class="alert alert-info text-center">
                                            No conversion rate data available for this period
                                        </div>
                                    `;
                                }

                                // Get date range for display
                                const dateRange = document.getElementById('dateRangeSelect').value;
                                const dateRangeText = dateRange === '7' ? 'Last 7 days' : 
                                                    dateRange === '30' ? 'Last 30 days' : 
                                                    dateRange === '90' ? 'Last 90 days' : 'Custom range';

                                // Update period label
                                document.getElementById('period-label').textContent = dateRangeText;

                                // Calculate current period metrics (using only data within the selected period)
                                const received = data.historical_data.received;
                                const sent = data.historical_data.sent;

                                // Calculate period totals (changes within the period)
                                const periodReceived = received[received.length - 1] - received[0];
                                const periodSent = sent[sent.length - 1] - sent[0];
                                const periodBalance = periodReceived - periodSent;

                                // Update Current Period section
                                document.getElementById('receivedMetric').textContent = 
                                    data.current_period.received.toLocaleString();
                                document.getElementById('sentMetric').textContent = 
                                    data.current_period.sent.toLocaleString();
                                document.getElementById('balanceMetric').textContent = 
                                    data.current_period.balance.toLocaleString();

                                // Calculate Growth Metrics
                                // Daily Change: Average change per day over the period
                                let totalReceivedChange = 0;
                                let daysWithChanges = 0;

                                // Calculate daily changes and growth rate
                                for (let i = 1; i < received.length; i++) {
                                    const receivedChange = received[i] - received[i-1];
                                    if (receivedChange !== 0) {
                                        totalReceivedChange += receivedChange;
                                        daysWithChanges++;
                                    }
                                }

                                // Daily Change: Average change on days when there were changes
                                const avgDailyChange = daysWithChanges > 0 ? 
                                    (totalReceivedChange / daysWithChanges).toFixed(1) : 0;

                                // Growth Rate: Percentage change from start to end of period
                                const startValue = received[0];
                                const endValue = received[received.length - 1];
                                const growthRate = startValue > 0 ? 
                                    (((endValue - startValue) / startValue) * 100).toFixed(1) : 0;

                                // Trend: Based on overall change during period
                                const trend = (endValue - startValue) > 0 ? 'Improving' : 'Declining';

                                // Update Growth Metrics section
                                document.getElementById('dailyChangeMetric').textContent = 
                                    (avgDailyChange > 0 ? '+' : '') + avgDailyChange;
                                document.getElementById('growthRateMetric').textContent = 
                                    (growthRate > 0 ? '+' : '') + growthRate + '%';
                                document.getElementById('trendMetric').textContent = trend;

                                // Calculate and update daily changes
                                const dailyChanges = {
                                    dates: data.historical_data.dates.slice(1),
                                    received: [],
                                    sent: []
                                };
                                
                                // Find first non-zero values (baselines)
                                let baselineReceivedIndex = data.historical_data.received.findIndex(val => val > 0);
                                let baselineSentIndex = data.historical_data.sent.findIndex(val => val > 0);
                                
                                // Calculate daily changes, but only after respective baselines
                                for (let i = 1; i < data.historical_data.dates.length; i++) {
                                    // For received changes
                                    if (i > baselineReceivedIndex && baselineReceivedIndex !== -1) {
                                        dailyChanges.received.push(
                                            data.historical_data.received[i] - data.historical_data.received[i-1]
                                        );
                                    } else {
                                        dailyChanges.received.push(0);
                                    }
                                    
                                    // For sent changes
                                    if (i > baselineSentIndex && baselineSentIndex !== -1) {
                                        dailyChanges.sent.push(
                                            data.historical_data.sent[i] - data.historical_data.sent[i-1]
                                        );
                                    } else {
                                        dailyChanges.sent.push(0);
                                    }
                                }

                                // Update daily changes chart
                                const dailyCtx = document.getElementById('dailyChangesChart').getContext('2d');
                                if (dailyChangesChart instanceof Chart) {
                                    dailyChangesChart.destroy();
                                }
                                dailyChangesChart = new Chart(dailyCtx, {
                                    type: 'line', // Changed from 'bar' to 'line'
                                    data: {
                                        labels: dailyChanges.dates,
                                        datasets: [{
                                            label: 'Received Changes',
                                            data: dailyChanges.received,
                                            borderColor: 'rgb(75, 192, 192)',
                                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                            tension: 0.1,
                                            fill: true
                                        }, {
                                            label: 'Sent Changes',
                                            data: dailyChanges.sent,
                                            borderColor: 'rgb(255, 99, 132)',
                                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                            tension: 0.1,
                                            fill: true
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                ticks: {
                                                    callback: function(value) {
                                                        return value > 0 ? '+' + value.toLocaleString() : value.toLocaleString();
                                                    }
                                                }
                                            }
                                        },
                                        plugins: {
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const value = context.parsed.y;
                                                        const formattedValue = value > 0 ? '+' + value.toLocaleString() : value.toLocaleString();
                                                        return `${context.dataset.label}: ${formattedValue}`;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                const chartContainer = document.getElementById('trendChart').parentElement;
                                chartContainer.innerHTML = `
                                    <div class="alert alert-danger">
                                        Error loading trends: ${error.message}
                                        <br>
                                        <small>Please try refreshing the page</small>
                                    </div>
                                `;
                            });
                    }

                    // Add this cleanup function
                    function closeTrendsPanel() {
                        const panel = document.getElementById('trendsPanel');
                        if (panel) {
                            panel.classList.remove('active');
                            // Clean up all charts
                            if (trendChart instanceof Chart) {
                                trendChart.destroy();
                                trendChart = null;
                            }
                            if (dailyChangesChart instanceof Chart) {
                                dailyChangesChart.destroy();
                                dailyChangesChart = null;
                            }
                            if (conversionRateChart instanceof Chart) {
                                conversionRateChart.destroy();
                                conversionRateChart = null;
                            }
                        }
                    }
                    

                    // 6. Update trend chart function
                    function updateTrendChart(chartData) {
                        try {
                            console.log("Updating trend chart with data:", chartData);
                            
                            // Validate data
                            if (!chartData.dates || !chartData.received || !chartData.sent) {
                                throw new Error('Missing required chart data');
                            }

                            const ctx = document.getElementById('trendChart').getContext('2d');
                            if (!ctx) {
                                throw new Error('Chart canvas not found');
                            }
                            
                            // Properly destroy existing chart if it exists
                            if (trendChart instanceof Chart) {
                                trendChart.destroy();
                            }
                            
                            // Create new chart
                            trendChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.dates,
                                    datasets: [{
                                        label: 'Received',
                                        data: chartData.received,
                                        borderColor: 'rgb(75, 192, 192)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }, {
                                        label: 'Sent',
                                        data: chartData.sent,
                                        borderColor: 'rgb(255, 99, 132)',
                                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                callback: function(value) {
                                                    return value.toLocaleString();
                                                }
                                            }
                                        }
                                    },
                                    plugins: {
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error updating trend chart:', error);
                            // Show error in UI
                            const container = document.getElementById('trendChart').parentElement;
                            container.innerHTML = `<div class="alert alert-danger">Error displaying chart: ${error.message}</div>`;
                        }
                    }

                    // 7. Format balance value function
                    function formatBalanceValue(value) {
                        if (isNaN(value)) value = 0;
                        const cls = value >= 0 ? 'positive' : 'negative';
                        return `<div class="d-flex justify-content-center">
                                  <span class="${cls}">${value.toLocaleString()}</span>
                                </div>`;
                    }

                   

                    function refreshData() {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const client = document.getElementById('clientSelect').value;
                        
                        console.log('Refreshing data for:', {
                            dateRange,
                            client
                        });
                        // TODO: Add API call to refresh data
                    }

                    // 9. Add these function definitions before your event listeners
                    let imbalances = [];

                    function formatDate(date) {
                        return date.toISOString().split('T')[0];  // Returns YYYY-MM-DD format
                    }

                    function loadDefaultDashboard() {
                        console.log('Loading dashboard...');
                        
                        // Get selected date range
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date(end);
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        const startStr = formatDate(start);
                        const endStr = formatDate(end);
                        
                        const url = `${API_BASE_URL}/api/largest-imbalances?start=${startStr}&end=${endStr}`;
                        
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Update table data
                                tableData = data;
                                
                                // Sort by balance (negative first)
                                sortTable('balance');
                                
                                renderTable();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.getElementById('imbalancesTableBody').innerHTML = 
                                    `<tr><td colspan="5" class="text-center">Error loading data: ${error.message}</td></tr>`;
                            });
                    }

                    function sortTable(column) {
                        // Update sort indicators
                        const headers = document.querySelectorAll('.sortable');
                        headers.forEach(header => {
                            header.classList.remove('asc', 'desc');
                        });
                        
                        const clickedHeader = document.querySelector(`.sortable[onclick*="sortTable('${column}')"]`);
                        const direction = currentSort.column === column && currentSort.direction === 'desc' ? 'asc' : 'desc';
                        clickedHeader?.classList.add(direction);
                        
                        // Sort the data
                        if (!tableData) return;
                        
                        tableData.sort((a, b) => {
                            let valueA, valueB;
                            
                            switch(column) {
                                case 'partner':
                                    valueA = a.partner?.toLowerCase() || '';
                                    valueB = b.partner?.toLowerCase() || '';
                                    return direction === 'desc' ? valueB.localeCompare(valueA) : valueA.localeCompare(valueB);
                                case 'received':
                                    valueA = a.period_received || 0;
                                    valueB = b.period_received || 0;
                                    break;
                                case 'sent':
                                    valueA = a.period_sent || 0;
                                    valueB = b.period_sent || 0;
                                    break;
                                case 'balance':
                                    valueA = a.period_balance || 0;
                                    valueB = b.period_balance || 0;
                                    break;
                                case 'allTimeBalance':
                                    valueA = a.all_time_balance || 0;
                                    valueB = b.all_time_balance || 0;
                                    break;
                                default:
                                    return 0;
                            }
                            
                            // For balance columns, sort negative numbers first when descending
                            if (column === 'balance' || column === 'allTimeBalance') {
                                return direction === 'desc' ? valueA - valueB : valueB - valueA;
                            }
                            // For other numeric columns, sort normally
                            return direction === 'desc' ? valueB - valueA : valueA - valueB;
                        });
                        
                        currentSort = { column, direction };
                        renderTable();
                    }

                    function updateTableHeaders() {
                        const isDefaultView = document.getElementById('clientSelect').value === 'all';
                        const thead = document.querySelector('table thead tr');
                        
                        thead.innerHTML = isDefaultView ? `
                            <th class="sortable" onclick="sortTable('partner')">Partner</th>
                            <th class="sortable" onclick="sortTable('account')">Client</th>
                            <th class="sortable" onclick="sortTable('received')">Received</th>
                            <th class="sortable" onclick="sortTable('sent')">Sent</th>
                            <th class="sortable desc" onclick="sortTable('balance')">Balance</th>
                            <th class="sortable" onclick="sortTable('allTimeBalance')">All-Time Balance</th>
                        ` : `
                            <th class="sortable" onclick="sortTable('partner')">Partner</th>
                            <th class="sortable" onclick="sortTable('received')">Received</th>
                            <th class="sortable" onclick="sortTable('sent')">Sent</th>
                            <th class="sortable desc" onclick="sortTable('balance')">Balance</th>
                            <th class="sortable" onclick="sortTable('allTimeBalance')">All-Time Balance</th>
                        `;
                    }

                    function renderTable() {
                        const tbody = document.querySelector('#activePartners');
                        const inactiveTbody = document.querySelector('#inactivePartnersSection');
                        tbody.innerHTML = '';
                        inactiveTbody.innerHTML = '';
                        
                        const isDefaultView = document.getElementById('clientSelect').value === 'all';
                        
                        // Use the already sorted tableData to split into active and inactive
                        const activePartners = tableData.filter(item => 
                            (item.period_received > 0 || item.period_sent > 0 || item.all_time_balance !== 0)
                        );
                        
                        const inactivePartners = tableData.filter(item => 
                            (item.period_received === 0 && item.period_sent === 0 && item.all_time_balance === 0)
                        );

                        // Render active partners
                        activePartners.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'table-row-clickable';
                            const avatarFile = avatar_mapping[item.partner] || 'default.png';
                            row.innerHTML = `
                                <td class="px-4 py-4 text-sm">
                                    <div class="d-flex align-items-center gap-3">
                                        <div 
                                            class="rounded-circle"
                                            style="
                                                width: 40px; 
                                                height: 40px; 
                                                background-color: var(--color-background-darker);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                            "
                                        >
                                            <img 
                                                src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                alt="${item.partner}"
                                                class="rounded-circle"
                                                style="width: 40px; height: 40px; object-fit: cover;"
                                                onerror="this.style.display='none'"
                                            >
                                        </div>
                                        <div class="fw-semibold">${item.partner}</div>
                                    </div>
                                </td>
                                <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: ${(item.latest_received || 0).toLocaleString()} (${item.latest_date ? new Date(item.latest_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'}), Start value: ${((item.latest_received || 0) - (item.period_received || 0)).toLocaleString()} (${item.start_date ? new Date(item.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'})">${(item.period_received || 0).toLocaleString()}</td>
                                <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: ${(item.latest_sent || 0).toLocaleString()} (${item.latest_date ? new Date(item.latest_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'}), Start value: ${((item.latest_sent || 0) - (item.period_sent || 0)).toLocaleString()} (${item.start_date ? new Date(item.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'})">${(item.period_sent || 0).toLocaleString()}</td>
                                <td class="table-number ${item.period_balance > 0 ? 'text-success' : 'text-danger'}" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest balance: ${(item.latest_received || 0) - (item.latest_sent || 0)} (${item.latest_date ? new Date(item.latest_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'}), Start balance: ${((item.latest_received || 0) - (item.period_received || 0)) - ((item.latest_sent || 0) - (item.period_sent || 0))} (${item.start_date ? new Date(item.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) || 'No date' : 'No date'})">${formatBalanceValue(item.period_balance || 0)}</td>
                                <td class="table-number ${item.all_time_balance > 0 ? 'text-success' : 'text-danger'}">${formatBalanceValue(item.all_time_balance || 0)}</td>
                            `;
                            
                            row.onclick = () => showTrendsPanel(
                                item.partner,
                                item.account
                            );
                            
                            tbody.appendChild(row);
                        });
                        
                        // Update inactive partners section similarly
                        inactivePartners.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'table-row-clickable';
                            const avatarFile = avatar_mapping[item.partner] || 'default.png';
                            row.innerHTML = `
                                <td class="px-4 py-4 text-sm">
                                    <div class="d-flex align-items-center gap-3">
                                        <div 
                                            class="rounded-circle"
                                            style="
                                                width: 40px; 
                                                height: 40px; 
                                                background-color: var(--color-background-darker);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                            "
                                        >
                                            <img 
                                                src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                alt="${item.partner}"
                                                class="rounded-circle"
                                                style="width: 40px; height: 40px; object-fit: cover;"
                                                onerror="this.style.display='none'"
                                            >
                                        </div>
                                        <div class="fw-semibold">${item.partner}</div>
                                    </div>
                                </td>
                                <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: 0, Start value: 0">0</td>
                                <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: 0, Start value: 0">0</td>
                                <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest balance: 0, Start balance: 0">0</td>
                                <td class="table-number">0</td>
                            `;
                            
                            row.onclick = () => showTrendsPanel(item.partner, item.account);
                            inactiveTbody.appendChild(row);
                        });
                        
                        // Update the "Show more" button text
                        const buttonText = document.querySelector('.show-more-button .button-text');
                        if (buttonText) {
                            buttonText.textContent = `Show ${inactivePartners.length} inactive partners`;
                        }
                    }

                    function updateTable(data) {
                        console.log('Raw data:', data);
                        
                        // Filter out the baseline record
                        const baselineDate = Math.min(...data.map(item => new Date(item.date)));
                        console.log('Baseline date:', baselineDate);
                        
                        // Calculate changes relative to baseline
                        const activeData = data.filter(item => new Date(item.date) > baselineDate)
                            .map(item => ({
                                ...item,
                                period_received: item.period_received - (
                                    data.find(d => d.date === baselineDate)?.period_received || 0
                                ),
                                period_sent: item.period_sent - (
                                    data.find(d => d.date === baselineDate)?.period_sent || 0
                                )
                            }));
                        console.log('Processed active data:', activeData);

                        // Store the processed data for sorting
                        tableData = activeData;
                        
                        // Apply default sort
                        sortTable('balance');
                        
                        // Render the table
                        const tableBody = document.getElementById('activePartners');
                        if (!tableBody) {
                            console.error('Table body element not found');
                            return;
                        }
                        
                        const html = activeData.map(item => `
                            <tr>
                                <td>${item.partner}</td>
                                <td>${formatNumber(item.period_received)}</td>
                                <td>${formatNumber(item.period_sent)}</td>
                                <td class="${item.period_balance >= 0 ? 'positive' : 'negative'}">
                                    ${formatNumber(Math.abs(item.period_balance))}
                                </td>
                                <td class="${item.all_time_balance >= 0 ? 'positive' : 'negative'}">
                                    ${formatNumber(Math.abs(item.all_time_balance))}
                                </td>
                            </tr>
                        `).join('');
                        
                        tableBody.innerHTML = html;
                        console.log('Table updated');
                    }

                    // Replace or update the client selector event listener
                    document.getElementById('clientSelect').addEventListener('change', async function() {
                        try {
                            const selectedClient = this.value;
                            closeTrendsPanel();
                            
                            if (selectedClient === 'all') {
                                toggleDashboardView('master');
                                await updateMasterDashboard();
                            } else {
                                toggleDashboardView('client');
                                try {
                                    const dateRange = document.getElementById('dateRangeSelect').value;
                                    const end = new Date();
                                    const start = new Date();
                                    start.setDate(end.getDate() - parseInt(dateRange));
                                    
                                    // Fetch recommendations
                                    const recommendationsResponse = await fetch(
                                        `${API_BASE_URL}/api/partnership-recommendations?account=${encodeURIComponent(selectedClient)}`
                                    );
                                    const recommendationsData = await recommendationsResponse.json();
                                    
                                    // Fetch metrics data with the correct endpoint
                                    const metricsUrl = `${API_BASE_URL}/api/partnership-metrics?` +
                                        `account=${encodeURIComponent(selectedClient)}&` +
                                        `start=${start.toISOString().split('T')[0]}&` +
                                        `end=${end.toISOString().split('T')[0]}`;
                                    
                                    const metricsResponse = await fetch(metricsUrl);
                                    const metricsData = await metricsResponse.json();
                                    
                                    // Update UI
                                    // First, ensure the defaultDashboard has the correct structure
                                    const defaultDashboard = document.getElementById('defaultDashboard');
                                    defaultDashboard.innerHTML = `
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <h3 class="mb-0">Largest Referral Imbalances</h3>
                                            <div class="d-flex align-items-center gap-3">
                                                <input type="text" 
                                                    class="form-control form-control-sm" 
                                                    placeholder="Search partners..." 
                                                    id="partnerSearch"
                                                    style="width: 250px; height: 38px;"
                                                    oninput="filterPartners(this.value)">
                                                <button class="btn btn-outline-primary d-inline-flex align-items-center gap-2" 
                                                        style="height: 38px;"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#manualEntryModal">
                                                    <i class="bi bi-plus-circle"></i> Add Manual Referrals
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable" onclick="sortTable('partner')">Partner</th>
                                                        <th class="sortable" onclick="sortTable('received')">Received</th>
                                                        <th class="sortable" onclick="sortTable('sent')">Sent</th>
                                                        <th class="sortable desc" onclick="sortTable('balance')">Balance</th>
                                                        <th class="sortable" onclick="sortTable('allTimeBalance')">All-Time Balance</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="activePartners">
                                                </tbody>
                                                <tbody id="inactivePartnersSection" class="collapse">
                                                </tbody>
                                            </table>
                                            <button class="show-more-button" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#inactivePartnersSection" 
                                                    aria-expanded="false">
                                            <span class="button-text">Show inactive partners</span>
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                        </div>`;

                                    // Add recommendations at the beginning
                                    if (recommendationsData && recommendationsData.recommendations) {
                                        const recommendationsHtml = renderRecommendations(recommendationsData);
                                        defaultDashboard.insertAdjacentHTML('afterbegin', recommendationsHtml);
                                    }
                                    
                                    // Update table data and render
                                    tableData = metricsData;
                                    await updateDashboardMetrics(metricsData);
                                    renderTable();
                                    
                                } catch (error) {
                                    console.error('Error loading client data:', error);
                                }
                            }
                        } catch (error) {
                            console.error('Error handling client selection:', error);
                        }
                    });

                    document.getElementById('dateRangeSelect').addEventListener('change', function() {
                        // Close the trends panel when changing date range
                        closeTrendsPanel();
                        
                        const selectedClient = document.getElementById('clientSelect').value;
                        const dateRange = this.value;
                        
                        // Calculate dates
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        // Always fetch fresh data regardless of client selection
                        const url = selectedClient === 'all' 
                            ? `${API_BASE_URL}/api/largest-imbalances?start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`
                            : `${API_BASE_URL}/api/partnership-metrics?account=${encodeURIComponent(selectedClient)}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`;
                        
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                // Update table data and maintain sort
                                tableData = data;
                                
                                // Update dashboard metrics including fastest growing/declining
                                updateDashboardMetrics(data);
                                
                                // Render the table with the new data
                                renderTable();
                            })
                            .catch(error => console.error('Error:', error));
                    });
                    
                    // Add this before your other fetch calls
                    fetch(`${API_BASE_URL}/data/avatars/avatar_mapping.json`)
                        .then(response => response.json())
                        .then(data => {
                            avatar_mapping = data;
                            console.log('Avatar mapping loaded:', avatar_mapping);
                            loadDefaultDashboard(); // Refresh the data after loading the mapping
                        })
                        .catch(error => console.error('Error loading avatar mapping:', error));
                    // Add this function to fetch trends
                    async function fetchPartnershipTrends() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate start and end dates based on selected range
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        const startStr = start.toISOString().split('T')[0];
                        const endStr = end.toISOString().split('T')[0];
                        
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/partnership-trends?account=${client}&start=${startStr}&end=${endStr}`);
                            const trends = await response.json();
                            
                            // Update the trends panel
                            updateTrendsPanel(trends);
                        } catch (error) {
                            console.error('Error fetching partnership trends:', error);
                        }
                    }

                    // Add this function to update the UI
                    function updateTrendsPanel(trends) {
                        const trendsPanel = document.querySelector('.partnership-trends');
                        if (!trendsPanel) {
                            // Create the panel if it doesn't exist
                            createTrendsPanel();
                        }
                        
                        // Update current period stats
                        document.getElementById('received-trend').textContent = trends.overall.received.end_total;
                        document.getElementById('sent-trend').textContent = trends.overall.sent.end_total;
                        document.getElementById('balance-trend').textContent = 
                            trends.overall.received.end_total - trends.overall.sent.end_total;
                        
                        // Update summary stats
                        document.getElementById('improving-relationships').textContent = 
                            trends.summary.improving_relationships;
                        document.getElementById('declining-relationships').textContent = 
                            trends.summary.declining_relationships;
                        
                        // Update fastest growing partners
                        const trendsList = document.getElementById('trends-list');
                        trendsList.innerHTML = trends.partner_trends
                            .slice(0, 5)  // Show top 5
                            .map(partner => `
                                <div class="trend-item">
                                    <div class="partner-name">${partner.partner}</div>
                                    <div class="trend-stats">
                                        <div>Growth: ${partner.growth.growth_rate}%</div>
                                        <div>Daily Change: ${partner.growth.daily_change}</div>
                                        <div class="trend-direction ${partner.growth.trend_direction.toLowerCase()}">
                                            ${partner.growth.trend_direction}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                    }

                    // Add this function to create the trends panel
                    function createTrendsPanel() {
                        const panel = document.createElement('div');
                        panel.className = 'partnership-trends';
                        panel.innerHTML = `
                            <h2>Partnership Trends</h2>
                            <div class="current-period">
                                <h3>Current Period</h3>
                                <div class="stats">
                                    <div>
                                        <label>Received</label>
                                        <span id="received-trend">0</span>
                                    </div>
                                    <div>
                                        <label>Sent</label>
                                        <span id="sent-trend">0</span>
                                    </div>
                                    <div>
                                        <label>Balance</label>
                                        <span id="balance-trend">0</span>
                                    </div>

                                </div>
                            </div>
                            <div class="relationship-summary">
                                <div>
                                    <label>Improving Relationships</label>
                                    <span id="improving-relationships">0</span>
                                </div>
                                <div>
                                    <label>Declining Relationships</label>
                                    <span id="declining-relationships">0</span>
                                </div>
                            </div>
                            <div class="fastest-growing">
                                <h3>Fastest Growing Partnerships</h3>
                                <div id="trends-list"></div>
                            </div>
                            <div class="fastest-declining">
                                <h3>Fastest Declining Partnerships</h3>
                                <div id="declining-trends-list"></div>
                            </div>
                        `;
                        
                        document.querySelector('.container').appendChild(panel);
                    }

                    // Update the existing loadData function to include trends
                    async function loadData() {
                        try {
                            const dateRange = document.getElementById('dateRangeSelect').value;
                            const client = document.getElementById('clientSelect').value;
                            const end = new Date();
                            const start = new Date();
                            start.setDate(end.getDate() - parseInt(dateRange));

                            // Use largest-imbalances for dashboard view, partnership-metrics for client view
                            const endpoint = client === 'all' ? 
                                'largest-imbalances' : 'partnership-metrics';
                            
                            const url = `${API_BASE_URL}/api/${endpoint}?` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}` +
                                (client !== 'all' ? `&account=${encodeURIComponent(client)}` : '');

                            const response = await fetch(url);
                            const data = await response.json();
                            
                            // Update all dashboard components with the same data
                            updateTopImbalances(data);
                            updateFastestGrowingDeclining(data);
                            updateDashboardMetrics(data);
                            updateNetworkGraph(data);
                            
                            // Update table
                            tableData = data;
                            renderTable();
                            
                        } catch (error) {
                            console.error('Error loading dashboard data:', error);
                        }
                    }

                    // Add function to update dashboard trends
                    function updateDashboardTrends() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate dates
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        fetch(`${API_BASE_URL}/api/overall-trends?account=${encodeURIComponent(client)}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`)
                            .then(response => response.json())
                            .then(data => {
                                // Update improving/declining counts
                                document.getElementById('improving-relationships').textContent = 
                                    data.summary.improving_relationships;
                                document.getElementById('declining-relationships').textContent = 
                                    data.summary.declining_relationships;
                                
                                // Update fastest growing list
                                const trendsList = document.getElementById('trends-list');
                                trendsList.innerHTML = data.fastest_growing
                                    .map(partner => `
                                        <div class="trend-item">
                                            <div class="partner-name">${partner.name}</div>
                                            <div class="trend-stats">
                                                <div>Growth: ${partner.growth_rate}%</div>
                                                <div class="trend-direction ${partner.trend_direction.toLowerCase()}">
                                                    ${partner.trend_direction}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('');
                            })
                            .catch(error => console.error('Error:', error));
                    }

                    // Initialize all tooltips
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl)
                    })

                    function updateTooltips(startDate, endDate, partnerName) {
                        // Format dates for display
                        const formatDate = (date) => {
                            return new Date(date).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            });
                        };
                        
                        const period = `${formatDate(startDate)} to ${formatDate(endDate)}`;
                        
                        // Update tooltip text
                        const dailyChangeTooltip = document.getElementById('dailyChangeTooltip');
                        const growthRateTooltip = document.getElementById('growthRateTooltip');
                        const trendTooltip = document.getElementById('trendTooltip');
                        
                        dailyChangeTooltip.setAttribute('title', 
                            `The average number of subscribers gained or lost per day from ${period}`);
                        growthRateTooltip.setAttribute('title', 
                            `Percentage increase or decrease in subscribers from ${period}`);
                        trendTooltip.setAttribute('title', 
                            `Overall direction of subscriber growth from ${period}`);
                        
                        // Make sure to destroy and reinitialize tooltips
                        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                        tooltips.forEach(el => {
                            const tooltip = bootstrap.Tooltip.getInstance(el);
                            if (tooltip) {
                                tooltip.dispose();
                            }
                            new bootstrap.Tooltip(el, {
                                container: 'body',
                                placement: 'left'
                            });
                        });
                    }
                    
                    // Call this function whenever you update your data
                    // For example, in your loadData() function:
                    async function loadData() {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        updateTooltips(start, end);
                        
                        // ... rest of your loadData function
                    }

                    function showPartnerTrends(creator) {
                        const panel = document.querySelector('.trends-panel');
                        // Set the partner name
                        document.getElementById('partnerName').textContent = creator;
                        
                        // Show the panel
                        panel.classList.add('active');
                        
                        console.log('Setting partner name to:', creator); // Debug log
                    }

                    // Wherever you handle the click to open the panel
                    function onPartnerClick(creator) {
                        console.log('Opening panel for:', creator);
                        showPartnerTrends(creator);
                    }

                    async function fetchImbalances() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;

                        // Calculate dates with proper time components
                        const end = new Date();
                        const start = new Date();

                        if (dateRange === "1" || dateRange === "2") {
                            // For 24/48 hours, subtract hours
                            start.setHours(end.getHours() - (parseInt(dateRange) * 24));
                        } else {
                            // For other ranges, continue using days
                            start.setDate(end.getDate() - parseInt(dateRange));
                        }

                        try {
                            // Add console.log to debug the request
                            console.log('Fetching data with params:', {
                                client,
                                start: start.toISOString(),
                                end: end.toISOString()
                            });

                            const response = await fetch(
                                `${API_BASE_URL}/api/partnership-metrics?` + 
                                `account=${encodeURIComponent(client)}&` +
                                `start=${start.toISOString()}&` +
                                `end=${end.toISOString()}`
                            );

                            const data = await response.json();
                            
                            // Add console.log to debug the response
                            console.log('Received data:', data);

                            // Update dashboard metrics first
                            await updateDashboardMetrics(data);
                            
                            // Update network graph
                            updateNetworkGraph(data);

                            // Update fastest growing/declining
                            updateFastestGrowingDeclining(data);

                            // Sort and update table
                            tableData = data.sort((a, b) => {
                                const balanceA = a.period_balance || 0;
                                const balanceB = b.period_balance || 0;
                                return balanceA - balanceB;
                            });
                            renderTable();

                        } catch (error) {
                            console.error('Error fetching data:', error);
                        }
                    }

                    async function updateDashboardMetrics(data) {
                        console.log('Updating dashboard metrics with data:', data);
                        
                        // Calculate Partnership Health
                        const improving = data.filter(p => p.period_balance > 0).length;
                        const declining = data.filter(p => p.period_balance < 0).length;
                        
                        // Update Partnership Health display
                        const improvingElement = document.querySelector('.metric:nth-child(1) .value');
                        const decliningElement = document.querySelector('.metric:nth-child(2) .value');
                        
                        if (improvingElement && decliningElement) {
                            improvingElement.textContent = improving;
                            decliningElement.textContent = declining;
                        }

                        // Calculate and update Fastest Growing/Declining
                        const fastestGrowing = [...data]
                            .filter(p => p.period_balance > 0)
                            .sort((a, b) => b.period_balance - a.period_balance)
                            .slice(0, 3);
                            
                        const fastestDeclining = [...data]
                            .filter(p => p.period_balance < 0)
                            .sort((a, b) => a.period_balance - b.period_balance)
                            .slice(0, 3);
                        
                        // Update Fastest Growing section
                        const fastestGrowingContainer = document.querySelector('.fastest-growing');
                        if (fastestGrowingContainer) {
                            fastestGrowingContainer.innerHTML = fastestGrowing
                                .map(partner => {
                                    const avatarFile = avatar_mapping[partner.partner] || 'default.png';
                                    return `
                                        <div class="growth-item positive">
                                            <div class="d-flex align-items-center">
                                                <div 
                                                    class="rounded-circle"
                                                    style="
                                                        width: 32px; 
                                                        height: 32px; 
                                                        background-color: var(--color-background-darker);
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        margin-right: 12px;
                                                    "
                                                >
                                                    <img 
                                                        src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                        alt="${partner.partner}"
                                                        class="rounded-circle"
                                                        style="width: 32px; height: 32px; object-fit: cover;"
                                                        onerror="this.style.display='none'"
                                                    >
                                                </div>
                                                <div style="line-height: 1.2;">
                                                    <div class="partner-name" style="margin-bottom: 2px;">${partner.partner}</div>
                                                    <div>
                                                        <span class="growth-value positive">+${partner.period_balance.toLocaleString()}</span>
                                                        <span class="period-label">last ${document.getElementById('dateRangeSelect').value} days</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                })
                                .join('');
                        }
                        
                        // Update Fastest Declining section
                        const fastestDecliningContainer = document.querySelector('.fastest-declining');
                        if (fastestDecliningContainer) {
                            fastestDecliningContainer.innerHTML = fastestDeclining
                                .map(partner => {
                                    const avatarFile = avatar_mapping[partner.partner] || 'default.png';
                                    return `
                                        <div class="growth-item negative">
                                            <div class="d-flex align-items-center">
                                                <div 
                                                    class="rounded-circle"
                                                    style="
                                                        width: 32px; 
                                                        height: 32px; 
                                                        background-color: var(--color-background-darker);
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        margin-right: 12px;
                                                    "
                                                >
                                                    <img 
                                                        src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                        alt="${partner.partner}"
                                                        class="rounded-circle"
                                                        style="width: 32px; height: 32px; object-fit: cover;"
                                                        onerror="this.style.display='none'"
                                                    >
                                                </div>
                                                <div style="line-height: 1.2;">
                                                    <div class="partner-name" style="margin-bottom: 2px;">${partner.partner}</div>
                                                    <div>
                                                        <span class="growth-value negative">${partner.period_balance.toLocaleString()}</span>
                                                        <span class="period-label">last ${document.getElementById('dateRangeSelect').value} days</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                })
                                .join('');
                        }
                    }

                    // Add this new helper function
                    function formatPeriodText(dateRange) {
                        const range = parseInt(dateRange);
                        if (range === 1) {
                            return 'last 24 hours';
                        } else if (range === 2) {
                            return 'last 48 hours';
                        } else {
                            return `last ${range} days`;
                        }
                    }

                    // Function to populate the partner dropdown based on current client
                    function populatePartnerDropdown() {
                        const currentClient = document.getElementById('clientSelect').value;
                        const partnerSelect = document.getElementById('manualPartner');
                        
                        console.log('Populating partners for client:', currentClient);
                        
                        // Clear existing options
                        partnerSelect.innerHTML = '<option value="">Select a partner...</option>';
                        
                        // Get partners from the table data instead of making an API call
                        const partners = Array.from(document.querySelectorAll('#defaultDashboard table tbody tr'))
                            .map(row => row.cells[0].textContent.trim());
                        
                        console.log('Found partners:', partners);
                        
                        // Add partners to dropdown
                        partners.forEach(partner => {
                            const option = document.createElement('option');
                            option.value = partner;
                            option.textContent = partner;
                            partnerSelect.appendChild(option);
                        });
                    }

        
                    
                    ;

                    function submitManualEntry() {
                        const partner = document.getElementById('manualPartner').value;
                        const date = document.getElementById('manualDate').value;
                        const received = document.getElementById('manualReceived').value;
                        const sent = document.getElementById('manualSent').value;
                        const notes = document.getElementById('manualNotes').value;

                        // Validate that at least one of received or sent has a value
                        if (!received && !sent) {
                            alert('Please enter either a Received or Sent value');
                            return;
                        }

                        const formData = {
                            partner: partner,
                            date: date,
                            received: received ? parseInt(received) : null,  // Only include if has value
                            sent: sent ? parseInt(sent) : null,  // Only include if has value
                            notes: notes
                        };

                        fetch(`${API_BASE_URL}/api/manual-referrals`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Close modal and refresh data
                            bootstrap.Modal.getInstance(document.getElementById('manualEntryModal')).hide();
                            refreshData();
                            
                            // Show success message
                            alert('Manual referral data added successfully!');
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error adding manual referral data');
                        });
                    }

                    function renderDashboardTable(data) {
                        console.log('Raw data received:', data);  // Log the initial data
                        
                        // Sort data to show active partners first
                        const activePartners = data.filter(row => {
                            const isActive = row.period_received !== 0 || row.period_sent !== 0 || row.all_time_balance !== 0;
                            console.log(`Partner ${row.partner}: active=${isActive}`, {
                                period_received: row.period_received,
                                period_sent: row.period_sent,
                                all_time_balance: row.all_time_balance
                            });
                            return isActive;
                        });
                        
                        const inactivePartners = data.filter(row => 
                            row.period_received === 0 && row.period_sent === 0 && row.all_time_balance === 0
                        );

                        console.log('Active partners:', activePartners);
                        console.log('Inactive partners:', inactivePartners);

                        let tableHtml = `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Received</th>
                                        <th>Sent</th>
                                        <th>Balance</th>
                                        <th>All-Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${activePartners.map(row => {
                                        console.log('Rendering active row:', row);
                                        return renderTableRow(row);
                                    }).join('')}
                                </tbody>
                                <tbody id="inactivePartners" class="collapse">
                                    ${inactivePartners.map(row => {
                                        console.log('Rendering inactive row:', row);
                                        return renderTableRow(row);
                                    }).join('')}
                                </tbody>
                            </table>
                            ${inactivePartners.length > 0 ? `
                                <button class="btn btn-link" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#inactivePartners"
                                        aria-expanded="false">
                                    Show ${inactivePartners.length} inactive partners
                                </button>
                            ` : ''}
                        `;

                        document.getElementById('defaultDashboard').innerHTML = tableHtml;
                    }

                    function renderTableRow(row) {
                        const avatarFile = avatar_mapping[row.partner] || 'default.png';
                        return `
                            <tr class="table-row-clickable">
                                <td class="px-4 py-4 text-sm">
                                    <div class="d-flex align-items-center gap-3">
                                        <div 
                                            class="rounded-circle"
                                            style="
                                                width: 40px; 
                                                height: 40px; 
                                                background-color: #dacaab;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                            "
                                        >
                                            <img 
                                                src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                alt="${row.partner}"
                                                class="rounded-circle"
                                                style="width: 40px; height: 40px; object-fit: cover;"
                                                onerror="this.style.display='none'"
                                            >
                                        </div>
                                        <div class="fw-semibold">${row.partner}</div>
                                    </div>
                                </td>
                                <td class="table-number">${row.period_received}</td>
                                <td class="table-number">${row.period_sent}</td>
                                <td class="table-number ${row.period_balance > 0 ? 'text-success' : 'text-danger'}">${formatBalanceValue(row.period_balance || 0)}</td>
                                <td class="table-number ${row.all_time_balance > 0 ? 'text-success' : 'text-danger'}">${formatBalanceValue(row.all_time_balance || 0)}</td>
                            </tr>
                        `;
                    }

                 ;

                    // Function to toggle between master and client views
                    function toggleDashboardView(view) {
                        const masterDash = document.getElementById('masterDashboard');
                        const clientDash = document.getElementById('defaultDashboard');
                        
                        if (view === 'master') {
                            masterDash.style.display = 'block';
                            clientDash.style.display = 'none';
                        } else {
                            masterDash.style.display = 'none';
                            clientDash.style.display = 'block';
                        }
                    }

                    // Update client selector event listener
                    document.getElementById('clientSelect').addEventListener('change', async function() {
                        const selectedClient = this.value;
                        closeTrendsPanel();
                        
                        // Clear any existing recommendations first
                        const defaultDashboard = document.getElementById('defaultDashboard');
                        const existingRecommendations = defaultDashboard.querySelectorAll('.card');
                        existingRecommendations.forEach(rec => {
                            if (rec.querySelector('h5')?.textContent === 'Possible Partnerships') {
                                rec.remove();
                            }
                        });
                        
                        if (selectedClient === 'all') {
                            toggleDashboardView('master');
                            await updateMasterDashboard();
                        } else {
                            toggleDashboardView('client');
                            try {
                                const dateRange = document.getElementById('dateRangeSelect').value;
                                const end = new Date();
                                const start = new Date();
                                start.setDate(end.getDate() - parseInt(dateRange));
                                
                                // Fetch recommendations
                                const recommendationsResponse = await fetch(
                                    `${API_BASE_URL}/api/partnership-recommendations?account=${encodeURIComponent(selectedClient)}`
                                );
                                const recommendationsData = await recommendationsResponse.json();
                                
                                // Fetch metrics data
                                const metricsUrl = new URL(`${API_BASE_URL}/api/partnership-metrics`);
                                metricsUrl.searchParams.append('account', selectedClient);
                                metricsUrl.searchParams.append('start', start.toISOString().split('T')[0]);
                                metricsUrl.searchParams.append('end', end.toISOString().split('T')[0]);
                                
                                const metricsResponse = await fetch(metricsUrl);
                                const metricsData = await metricsResponse.json();
                                
                                // Update UI
                                const recommendationsHtml = renderRecommendations(recommendationsData);
                                defaultDashboard.insertAdjacentHTML('afterbegin', recommendationsHtml);
                                
                                // Update other dashboard components
                                tableData = metricsData;
                                await updateDashboardMetrics(metricsData);
                                renderTable();
                                
                            } catch (error) {
                                console.error('Error loading client data:', error);
                            }
                        }
                    });

                    // Update the DOMContentLoaded event listener to be simpler
                    document.addEventListener('DOMContentLoaded', async function() {
                        try {
                            // Load avatar mapping
                            const avatarResponse = await fetch(`${API_BASE_URL}/data/avatars/avatar_mapping.json`);
                            avatar_mapping = await avatarResponse.json();
                            
                            // Initialize master dashboard view
                            toggleDashboardView('master');
                            await updateMasterDashboard();
                            
                            // Initialize tooltips
                            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                            tooltips.forEach(el => new bootstrap.Tooltip(el));
                        } catch (error) {
                            console.error('Error during initialization:', error);
                        }
                    });

                    // Function to update the master dashboard
                    async function updateMasterDashboard() {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        try {
                            // Changed to use partnership-metrics endpoint
                            const response = await fetch(`${API_BASE_URL}/api/partnership-metrics?start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`);
                            const data = await response.json();
                            
                            // Process data for master view
                            updateNetworkHealth(data);
                            updateTopImbalances(data);
                            updateRecentlyInactive(data);
                            updateNetworkGraph(data);
                            updateFastestGrowingDeclining();
                        } catch (error) {
                            console.error('Error updating master dashboard:', error);
                        }
                    }

                    // Update these helper functions to match the new data structure
                    function updateNetworkHealth(data) {
                        const totalActive = data.filter(p => p.period_received > 0 || p.period_sent > 0).length;
                        const troubled = data.filter(p => Math.abs(p.period_balance) > 100).length;
                        
                        document.getElementById('totalPartnerships').textContent = totalActive;
                        document.getElementById('troubledPartnerships').textContent = troubled;
                    }

                    function updateTopImbalances(data) {
                        const receivingMore = data
                            .filter(p => p.period_balance > 0)
                            .sort((a, b) => b.period_balance - a.period_balance)
                            .slice(0, 3);
                        
                        const sendingMore = data
                            .filter(p => p.period_balance < 0)
                            .sort((a, b) => a.period_balance - b.period_balance)
                            .slice(0, 3);
                        
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        const html = `
                            <p class="text-muted mb-4">
                                Showing the most significant referral imbalances over the last ${dateRange}. 
                                Positive numbers indicate partners sending us more referrals than we send them, 
                                negative numbers indicate where we're sending more than we receive.
                            </p>
                            
                            <h5 class="text-success">Top Referring Partners</h5>
                            ${renderImbalanceList(receivingMore)}
                            
                            <h5 class="text-danger mt-4">Needs Attention</h5>
                            ${renderImbalanceList(sendingMore)}
                        `;
                        
                        document.getElementById('topImbalances').innerHTML = html;
                    }

                    function renderImbalanceList(items) {
                        return items.length > 0 ? items.map(p => `
                            <div class="growth-item ${p.period_balance >= 0 ? 'positive' : 'negative'}">
                                <div class="d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                            <h6 class="partner-name mb-0">${p.partner}</h6>
                                            <small class="text-muted d-block">Client: ${p.account}</small>
                                    </div>
                                        <span class="${p.period_balance >= 0 ? 'positive' : 'negative'}">
                                            ${Math.abs(p.period_balance).toLocaleString()}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                        Sent: ${p.period_sent.toLocaleString()} | 
                                        Received: ${p.period_received.toLocaleString()}
                                    </small>
                                    </div>
                            </div>
                        `).join('') : '<div class="text-muted">No partnerships found</div>';
                    }

                    function updateRecentlyInactive(data) {
                        const html = `
                            <p class="text-muted mb-4">
                                Partners with previous referral activity but no exchanges in the last 30 days. 
                                "All-time" balance shows the historical referral difference (received - sent).
                            </p>
                            ${renderInactiveList(data)}
                        `;
                        
                        document.getElementById('recentlyInactive').innerHTML = html;
                    }

                    function renderInactiveList(data) {
                        const inactive = data
                            .filter(p => p.period_received === 0 && 
                                        p.period_sent === 0 && 
                                        p.all_time_balance !== 0)
                            .slice(0, 5);
                        
                        return inactive.length > 0 ? 
                            inactive.map(p => `
                                <div class="growth-item negative">
                                    <div class="d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-center">
                                <div>
                                                <h6 class="partner-name mb-0">${p.partner}</h6>
                                                <small class="text-muted d-block">Client: ${p.account}</small>
                                </div>
                                            <span class="text-muted">
                                                All-time: ${p.all_time_balance.toLocaleString()}
                                            </span>
                                </div>
                                        <small class="text-muted">
                                            Last active: ${p.last_active || 'Unknown'}
                                        </small>
                            </div>
                            </div>
                            `).join('') :
                            '<div class="text-muted">No inactive partnerships found</div>';
                    }

                

                    // Add this function to your JavaScript
                    function updateNetworkGraph(data) {
                        // Clear existing graph
                        d3.select("#networkGraph").html("");

                        // Process data for network visualization
                        const nodes = [];
                        const links = [];
                        const nodeMap = new Map();

                        // Create nodes for each unique partner and account
                        data.forEach(d => {
                            if (!nodeMap.has(d.partner)) {
                                nodeMap.set(d.partner, {
                                    id: d.partner,
                                    group: d.account,
                                    totalActivity: d.period_received + d.period_sent
                                });
                            }
                            if (!nodeMap.has(d.account)) {
                                nodeMap.set(d.account, {
                                    id: d.account,
                                    group: d.account,
                                    totalActivity: 0
                                });
                            }
                        });

                        // Create links between partners with active referrals
                        data.forEach(d => {
                            if (d.period_received > 0) {
                                links.push({
                                    source: d.partner,
                                    target: d.account,
                                    value: d.period_received,
                                    type: "received"
                                });
                            }
                            if (d.period_sent > 0) {
                                links.push({
                                    source: d.account,
                                    target: d.partner,
                                    value: d.period_sent,
                                    type: "sent"
                                });
                            }
                        });

                        // Set up the SVG
                        const width = 800;
                        const height = 600;

                        const svg = d3.select("#networkGraph")
                            .append("svg")
                            .attr("width", width)
                            .attr("height", height);

                        // Create the force simulation
                        const simulation = d3.forceSimulation(Array.from(nodeMap.values()))
                            .force("link", d3.forceLink(links).id(d => d.id))
                            .force("charge", d3.forceManyBody().strength(-400))
                            .force("center", d3.forceCenter(width / 2, height / 2));

                        // Add the links
                        const link = svg.append("g")
                            .selectAll("line")
                            .data(links)
                            .join("line")
                            .attr("stroke-width", d => Math.sqrt(d.value))
                            .attr("stroke", d => d.type === "received" ? "#28a745" : "#dc3545");

                        // Add the nodes
                        const node = svg.append("g")
                            .selectAll("circle")
                            .data(Array.from(nodeMap.values()))
                            .join("circle")
                            .attr("r", d => Math.sqrt(d.totalActivity) + 5)
                            .attr("fill", "#fff")
                            .attr("stroke", "#333")
                            .attr("stroke-width", 1.5)
                            .call(drag(simulation));

                        // Add labels
                        const label = svg.append("g")
                            .selectAll("text")
                            .data(Array.from(nodeMap.values()))
                            .join("text")
                            .text(d => d.id)
                            .attr("font-size", 10)
                            .attr("dx", 12)
                            .attr("dy", 4);

                        // Update positions on each tick
                        simulation.on("tick", () => {
                            link
                                .attr("x1", d => d.source.x)
                                .attr("y1", d => d.source.y)
                                .attr("x2", d => d.target.x)
                                .attr("y2", d => d.target.y);

                            node
                                .attr("cx", d => d.x)
                                .attr("cy", d => d.y);

                            label
                                .attr("x", d => d.x)
                                .attr("y", d => d.y);
                        });
                    }

                    // Add drag behavior
                    function drag(simulation) {
                        function dragstarted(event) {
                            if (!event.active) simulation.alphaTarget(0.3).restart();
                            event.subject.fx = event.subject.x;
                            event.subject.fy = event.subject.y;
                        }
                        
                        function dragged(event) {
                            event.subject.fx = event.x;
                            event.subject.fy = event.y;
                        }
                        
                        function dragended(event) {
                            if (!event.active) simulation.alphaTarget(0);
                            event.subject.fx = null;
                            event.subject.fy = null;
                        }
                        
                        return d3.drag()
                            .on("start", dragstarted)
                            .on("drag", dragged)
                            .on("end", dragended);
                    }

                    // Add the fastest growing/declining update
                    async function updateFastestGrowingDeclining() {
                        try {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date();
                            start.setDate(end.getDate() - parseInt(dateRange));

                            // Fetch data from partnership-metrics endpoint
                            const response = await fetch(
                                `${API_BASE_URL}/api/partnership-metrics?` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}`
                            );

                            const data = await response.json();
                            
                            // Filter and sort for growing partnerships (positive balance)
                            const fastestGrowing = data
                            .filter(p => p.period_balance > 0)
                            .sort((a, b) => b.period_balance - a.period_balance)
                            .slice(0, 3);
                            
                            // Filter and sort for declining partnerships (negative balance)
                            const fastestDeclining = data
                            .filter(p => p.period_balance < 0)
                            .sort((a, b) => a.period_balance - b.period_balance)
                            .slice(0, 3);
                        
                            // Update the growing partnerships section
                            const growingContainer = document.querySelector('.fastest-growing');
                            if (growingContainer) {
                                growingContainer.innerHTML = fastestGrowing.length > 0 ?
                                    fastestGrowing.map(partner => {
                                    const avatarFile = avatar_mapping[partner.partner] || 'default.png';
                                    return `
                                        <div class="growth-item positive">
                                            <div class="d-flex align-items-center">
                                                <div 
                                                    class="rounded-circle"
                                                    style="
                                                        width: 32px; 
                                                        height: 32px; 
                                                        background-color: var(--color-background-darker);
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        margin-right: 12px;
                                                    "
                                                >
                                                    <img 
                                                        src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                        alt="${partner.partner}"
                                                        class="rounded-circle"
                                                        style="width: 32px; height: 32px; object-fit: cover;"
                                                        onerror="this.style.display='none'"
                                                    >
                                                </div>
                                                <div style="line-height: 1.2;">
                                                    <div class="partner-name" style="margin-bottom: 2px;">${partner.partner}</div>
                                                    <div>
                                                        <span class="growth-value positive">+${partner.period_balance.toLocaleString()}</span>
                                                            <span class="period-label">last ${dateRange} days</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('') :
                                    '<p class="text-muted">No growing partnerships found</p>';
                            }

                            // Update the declining partnerships section
                            const decliningContainer = document.querySelector('.fastest-declining');
                            if (decliningContainer) {
                                decliningContainer.innerHTML = fastestDeclining.length > 0 ?
                                    fastestDeclining.map(partner => {
                                    const avatarFile = avatar_mapping[partner.partner] || 'default.png';
                                    return `
                                        <div class="growth-item negative">
                                            <div class="d-flex align-items-center">
                                                <div 
                                                    class="rounded-circle"
                                                    style="
                                                        width: 32px; 
                                                        height: 32px; 
                                                        background-color: var(--color-background-darker);
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        margin-right: 12px;
                                                    "
                                                >
                                                    <img 
                                                        src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                        alt="${partner.partner}"
                                                        class="rounded-circle"
                                                        style="width: 32px; height: 32px; object-fit: cover;"
                                                        onerror="this.style.display='none'"
                                                    >
                                                </div>
                                                <div style="line-height: 1.2;">
                                                    <div class="partner-name" style="margin-bottom: 2px;">${partner.partner}</div>
                                                    <div>
                                                        <span class="growth-value negative">${partner.period_balance.toLocaleString()}</span>
                                                            <span class="period-label">last ${dateRange} days</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('') :
                                    '<p class="text-muted">No declining partnerships found</p>';
                            }
                        } catch (error) {
                            console.error('Error updating fastest growing/declining:', error);
                        }
                    }

                    async function updateDashboard() {
                        try {
                                const end = new Date();
                                const start = new Date();
                                start.setDate(end.getDate() - parseInt(dateRange));
                                
                            // Replace multiple largest-imbalances calls with single partnership-metrics call
                            const response = await fetch(
                                `${API_BASE_URL}/api/partnership-metrics?` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}`
                            );

                                const data = await response.json();
                            updateTopImbalances(data);
                                
                            } catch (error) {
                            console.error('Error updating dashboard:', error);
                        }
                    }

                    // Remove any other functions that call largest-imbalances
                </script>

                <!-- Add this at the end of the body -->
                <div class="modal fade" id="manualEntryModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Manual Referral Data</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                            <div class="modal-body">
                                <form id="manualEntryForm">
                                    <div class="mb-3">
                                        <label class="form-label">Partner</label>
                                        <select class="form-select" id="manualPartner" required>
                                            <option value="">Select a partner...</option>
                                            <!-- Will be populated with current client's partners -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="manualDate" required>
                                </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="mb-3">
                                                <label class="form-label">Received</label>
                                                <input type="number" class="form-control" id="manualReceived" 
                                                       placeholder="Optional">
                                    </div>
                                    </div>
                                        <div class="col">
                                            <div class="mb-3">
                                                <label class="form-label">Sent</label>
                                                <input type="number" class="form-control" id="manualSent" 
                                                       placeholder="Optional">
                                    </div>
                                </div>
                            </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" id="manualNotes" rows="2" 
                                                placeholder="e.g., Data from external tool"></textarea>
                                </div>
                                </form>
                                </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitManualEntry()">Save</button>
                            </div>
                            </div>
                            </div>
                </div>

                <script>
                    async function updatePartnershipTrends(partner, account) {
                        try {
                            const dateRange = document.getElementById('dateRangeSelect').value;
                            const end = new Date();
                            const start = new Date();
                            start.setDate(end.getDate() - parseInt(dateRange));

                            const response = await fetch(
                                `${API_BASE_URL}/api/partnership-trends?` +
                                `partner=${encodeURIComponent(partner)}&` +
                                `account=${encodeURIComponent(account)}&` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}`
                            );

                            const data = await response.json();
                            console.log('Raw trend data:', data);  // Debug log

                            // Clean up and deduplicate dates
                            const uniqueDates = [...new Set(data.historical_data.dates)].sort();
                            const dateIndices = new Map(uniqueDates.map((date, index) => [date, index]));

                            // Create arrays for the cleaned data
                            const cleanedData = {
                                dates: uniqueDates,
                                received: new Array(uniqueDates.length).fill(0),
                                sent: new Array(uniqueDates.length).fill(0)
                            };

                            // Map the data to the correct indices
                            data.historical_data.dates.forEach((date, i) => {
                                const index = dateIndices.get(date);
                                cleanedData.received[index] = data.historical_data.received[i] || 0;
                                cleanedData.sent[index] = data.historical_data.sent[i] || 0;
                            });

                        // Format dates for display
                            const chartData = {
                                dates: cleanedData.dates.map(d => {
                                    const date = new Date(d);
                                    return `${date.getMonth() + 1}/${date.getDate()}`;
                                }),
                                received: cleanedData.received,
                                sent: cleanedData.sent
                            };

                            console.log('Processed chart data:', chartData);  // Debug log

                            // Create new chart with processed data
                            const ctx = document.getElementById('trendChart').getContext('2d');
                            if (trendChart) {
                                trendChart.destroy();
                            }

                            trendChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.dates,
                                    datasets: [{
                                        label: 'Received',
                                        data: chartData.received,
                                        borderColor: '#28a745',
                                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                        tension: 0.1,
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        fill: true,
                                        spanGaps: false // Don't connect points across gaps
                                    }, {
                                        label: 'Sent',
                                        data: chartData.sent,
                                        borderColor: '#dc3545',
                                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                        tension: 0.1,
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        fill: true,
                                        spanGaps: false // Don't connect points across gaps
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'top'
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                callback: function(value) {
                                                    return value.toLocaleString();
                                                }
                                            }
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                interaction: {
                                    mode: 'nearest',
                                    axis: 'x',
                                    intersect: false
                                }
                            });
                        } catch (error) {
                            console.error('Error updating partnership trends:', error);
                        }
                    }
                </script>

                <script>
                    async function loadPartnershipData(partner) {
                        try {
                        const client = document.getElementById('clientSelect').value;
                            const days = document.getElementById('dateRangeSelect').value;

                        const end = new Date();
                            const start = new Date(end);
                            start.setDate(start.getDate() - days);
                            
                            // Load historical trend data
                            const trendResponse = await fetch(
                                `${API_BASE_URL}/api/partnership-trends?` +
                                `account=${client}&` +
                                `partner=${partner}&` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}`
                            );
                            const trendData = await trendResponse.json();
                            
                            // Load daily changes data
                            const changesResponse = await fetch(
                                `${API_BASE_URL}/api/daily-changes?` +
                                `account=${client}&` +
                                `partner=${partner}&` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}&` +
                                `t=${Date.now()}`  // Add timestamp to bust cache
                            );
                            const changesData = await changesResponse.json();
                            
                            // Get the first non-zero values (baselines)
                            const firstSentIndex = changesData.daily_changes.findIndex(c => c.sent !== 0);
                            const firstReceivedIndex = changesData.daily_changes.findIndex(c => c.received !== 0);
                            
                            // Filter out the baseline days
                            const filteredChanges = changesData.daily_changes.map((change, index) => ({
                                date: change.date,
                                sent: index <= firstSentIndex ? 0 : change.sent,
                                received: index <= firstReceivedIndex ? 0 : change.received
                            }));
                            
                            // Update charts
                            updateTrendChart(trendData.historical_data);
                            updateDailyChart(filteredChanges);

                        } catch (error) {
                            console.error('Error loading partnership data:', error);
                        }
                    }
                </script>

                

                <!-- Add this JavaScript right after your existing scripts -->
                <script>
                    // Add search functionality
                    document.getElementById('partnerSearch').addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase();
                        
                        // Filter the tableData
                        const filteredData = tableData.filter(item => 
                            item.partner.toLowerCase().includes(searchTerm)
                        );
                        
                        // Re-render table with filtered data
                        const activePartners = filteredData.filter(item => 
                            (item.period_received > 0 || item.period_sent > 0 || item.all_time_balance !== 0)
                        );
                        
                        const inactivePartners = filteredData.filter(item => 
                            (item.period_received === 0 && item.period_sent === 0 && item.all_time_balance === 0)
                        );
                        
                        // Update active partners
                        const tbody = document.querySelector('#activePartners');
                        tbody.innerHTML = activePartners.map(item => {
                            const avatarFile = avatar_mapping[item.partner] || 'default.png';
                                    return `
                                <tr class="table-row-clickable" onclick="showTrendsPanel('${item.partner}', '${item.account}')">
                                    <td class="px-4 py-4 text-sm">
                                        <div class="d-flex align-items-center gap-3">
                                                <div 
                                                    class="rounded-circle"
                                                    style="
                                                    width: 40px; 
                                                    height: 40px; 
                                                        background-color: var(--color-background-darker);
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                    "
                                                >
                                                    <img 
                                                        src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                    alt="${item.partner}"
                                                        class="rounded-circle"
                                                    style="width: 40px; height: 40px; object-fit: cover;"
                                                        onerror="this.style.display='none'"
                                                    >
                                                </div>
                                            <div class="fw-semibold">${item.partner}</div>
                                                    </div>
                                    </td>
                                    <td class="table-number">${(item.period_received || 0).toLocaleString()}</td>
                                    <td class="table-number">${(item.period_sent || 0).toLocaleString()}</td>
                                    <td class="table-number ${item.period_balance > 0 ? 'text-success' : 'text-danger'}">
                                        ${formatBalanceValue(item.period_balance || 0)}
                                    </td>
                                    <td class="table-number ${item.all_time_balance > 0 ? 'text-success' : 'text-danger'}">
                                        ${formatBalanceValue(item.all_time_balance || 0)}
                                    </td>
                                    </tr>
                            `;
                        }).join('');
                        
                        // Update inactive partners
                        const inactiveTbody = document.querySelector('#inactivePartnersSection');
                        inactiveTbody.innerHTML = inactivePartners.map(item => {
                            const avatarFile = avatar_mapping[item.partner] || 'default.png';
                        return `
                                <tr class="table-row-clickable" onclick="showTrendsPanel('${item.partner}', '${item.account}')">
                                <td class="px-4 py-4 text-sm">
                                    <div class="d-flex align-items-center gap-3">
                                        <div 
                                            class="rounded-circle"
                                            style="
                                                width: 40px; 
                                                height: 40px; 
                                                    background-color: var(--color-background-darker);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                            "
                                        >
                                            <img 
                                                src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                    alt="${item.partner}"
                                                class="rounded-circle"
                                                style="width: 40px; height: 40px; object-fit: cover;"
                                                onerror="this.style.display='none'"
                                            >
                                        </div>
                                            <div class="fw-semibold">${item.partner}</div>
                                    </div>
                                </td>
                                    <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: 0, Start value: 0">0</td>
                                    <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest value: 0, Start value: 0">0</td>
                                    <td class="table-number" data-bs-toggle="tooltip" data-bs-placement="top" title="Latest balance: 0, Start balance: 0">0</td>
                                    <td class="table-number">0</td>
                            </tr>
                        `;
                        }).join('');
                        
                        // Update the "Show more" button text
                        const buttonText = document.querySelector('.show-more-button .button-text');
                        if (buttonText) {
                            buttonText.textContent = `Show ${inactivePartners.length} inactive partners`;
                        }
                    });
                </script>

                <script>
                    function filterPartners(searchTerm) {
                        if (!tableData) return;
                        
                        searchTerm = searchTerm.toLowerCase();
                        const tbody = document.querySelector('#activePartners');
                        const inactiveTbody = document.querySelector('#inactivePartnersSection');
                        
                        // Filter all rows
                        const rows = [...tbody.querySelectorAll('tr'), ...inactiveTbody.querySelectorAll('tr')];
                        
                        rows.forEach(row => {
                            const partnerName = row.querySelector('.fw-semibold').textContent.toLowerCase();
                            if (partnerName.includes(searchTerm)) {
                                row.style.display = '';
                        } else {
                                row.style.display = 'none';
                            }
                        });
                    }
                </script>

                <script>
                    document.getElementById('clientSelect').addEventListener('change', function(e) {
                        // Toggle search visibility
                        const searchContainer = document.getElementById('searchContainer');
                        if (searchContainer) {
                            searchContainer.style.display = e.target.value === 'all' ? 'none' : 'block';
                        }
                        loadData();
                    });
                </script>

                <script>
                    document.getElementById('clientSelect').addEventListener('change', async function() {
                        const selectedClient = this.value;
                        closeTrendsPanel();
                        
                        // Clear any existing recommendations first
                        const defaultDashboard = document.getElementById('defaultDashboard');
                        const existingRecommendations = defaultDashboard.querySelectorAll('.card');
                        existingRecommendations.forEach(rec => {
                            if (rec.querySelector('h5')?.textContent === 'Possible Partnerships') {
                                rec.remove();
                            }
                        });
                        
                        if (selectedClient === 'all') {
                            toggleDashboardView('master');
                            await updateMasterDashboard();
                        } else {
                            toggleDashboardView('client');
                            try {
                                const dateRange = document.getElementById('dateRangeSelect').value;
                                const end = new Date();
                                const start = new Date();
                                start.setDate(end.getDate() - parseInt(dateRange));
                                
                                // Fetch recommendations
                                const recommendationsResponse = await fetch(
                                    `${API_BASE_URL}/api/partnership-recommendations?account=${encodeURIComponent(selectedClient)}`
                                );
                                const recommendationsData = await recommendationsResponse.json();
                                
                                // Fetch metrics data
                                const metricsUrl = new URL(`${API_BASE_URL}/api/partnership-metrics`);
                                metricsUrl.searchParams.append('account', selectedClient);
                                metricsUrl.searchParams.append('start', start.toISOString().split('T')[0]);
                                metricsUrl.searchParams.append('end', end.toISOString().split('T')[0]);
                                
                                const metricsResponse = await fetch(metricsUrl);
                                const metricsData = await metricsResponse.json();
                                
                                // Update UI
                                const recommendationsHtml = renderRecommendations(recommendationsData);
                                defaultDashboard.insertAdjacentHTML('afterbegin', recommendationsHtml);
                                
                                // Update other dashboard components
                                tableData = metricsData;
                                await updateDashboardMetrics(metricsData);
                                renderTable();
                                
                            } catch (error) {
                                console.error('Error loading client data:', error);
                            }
                        }
                    });
                </script>

                <script>
                    // Add these variables at the top of your script section
                    let currentPartnershipPage = 0;
                    let totalPartnershipPages = 0;
                    let allPartnerships = [];

                    // Replace the existing renderRecommendations function
                    function renderRecommendations(data) {
                        // Early return with empty string if no data
                        if (!data || !data.recommendations || data.recommendations.length === 0) {
                            return '';
                        }

                        // Remove ALL existing partnership modules first
                        const existingModules = document.querySelectorAll('.card');
                        existingModules.forEach(module => {
                            const heading = module.querySelector('h5');
                            if (heading && heading.textContent === 'Possible Partnerships') {
                                module.remove();
                            }
                        });

                        // Store all partnerships globally, but limit to 10
                        allPartnerships = Array.from(
                            new Map(data.recommendations.map(item => [item.partner, item])).values()
                        ).slice(0, 10); // Limit to 10 partnerships
                        
                        totalPartnershipPages = Math.ceil(allPartnerships.length / 3);
                        currentPartnershipPage = 0;

                        const avgVolume = data.metrics?.your_avg_volume || 0;
                        return `
                            <div class="card mb-4">
                                <div class="card-body position-relative">
                                    <h5 class="mb-2">Possible Partnerships</h5>
                                    <p class="text-muted small mb-3">Your average outbound volume: ${avgVolume.toLocaleString()} referrals/month</p>
                                    
                                    <div class="partnership-nav-container">
                                        <button class="btn partnership-nav" onclick="previousPartnerships()" id="prevBtn" disabled>
                                            <i class="bi bi-chevron-left"></i>
                                        </button>
                                        <button class="btn partnership-nav" onclick="nextPartnerships()" id="nextBtn" ${totalPartnershipPages <= 1 ? 'disabled' : ''}>
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>

                                    <div class="partnership-carousel">
                                        <div class="row partnership-slide" id="partnershipSlide">
                                            ${renderPartnershipPage(0)}
                                        </div>
                                    </div>

                                    <div class="partnership-indicators">
                                        ${Array(totalPartnershipPages).fill(0).map((_, i) => `
                                            <div class="indicator ${i === 0 ? 'active' : ''}" onclick="goToPage(${i})"></div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Add these new functions after renderRecommendations
                    function renderPartnershipPage(page) {
                        const start = page * 3;
                        const partnerships = allPartnerships.slice(start, start + 3);
                        
                        // Create an array of 3 slots, fill with partnerships or empty divs
                        return Array(3).fill(null).map((_, index) => {
                            const partner = partnerships[index];
                            if (!partner) {
                                return `<div class="col-md-4"></div>`; // Empty column for spacing
                            }
                            
                            const avatarFile = avatar_mapping[partner.partner] || 'default.png';
                            return `
                                <div class="col-md-4">
                                    <div class="p-3 border rounded">
                                        <div class="d-flex align-items-center">
                                            <div 
                                                class="rounded-circle"
                                                style="
                                                    width: 40px; 
                                                    height: 40px; 
                                                    background-color: var(--color-background-darker);
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    margin-right: 12px;
                                                "
                                            >
                                                <img 
                                                    src="${API_BASE_URL}/data/avatars/${avatarFile}" 
                                                    alt="${partner.partner}"
                                                    class="rounded-circle"
                                                    style="width: 40px; height: 40px; object-fit: cover;"
                                                    onerror="this.style.display='none'"
                                                >
                                            </div>
                                            <div>
                                                <div class="fw-bold">${partner.partner}</div>
                                                <div class="text-muted">${partner.volume_match.split('(')[0].trim()}</div>
                                                <div class="text-muted">Partner: ${partner.example_partnership}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    function updatePartnershipDisplay() {
                        const slide = document.getElementById('partnershipSlide');
                        if (!slide) return;

                        // Update the content of the slide
                        slide.innerHTML = renderPartnershipPage(currentPartnershipPage);
                        
                        // Update navigation buttons
                        document.getElementById('prevBtn').disabled = currentPartnershipPage === 0;
                        document.getElementById('nextBtn').disabled = currentPartnershipPage === totalPartnershipPages - 1;
                        
                        // Update indicators
                        const indicators = document.querySelectorAll('.indicator');
                        indicators.forEach((indicator, index) => {
                            indicator.classList.toggle('active', index === currentPartnershipPage);
                        });
                    }

                    function nextPartnerships() {
                        if (currentPartnershipPage < totalPartnershipPages - 1) {
                            currentPartnershipPage++;
                            updatePartnershipDisplay();
                        }
                    }

                    function previousPartnerships() {
                        if (currentPartnershipPage > 0) {
                            currentPartnershipPage--;
                            updatePartnershipDisplay();
                        }
                    }

                    function goToPage(page) {
                        if (page >= 0 && page < totalPartnershipPages) {
                            currentPartnershipPage = page;
                            updatePartnershipDisplay();
                        }
                    }
                </script>

                <!-- Add Account Manager Modal -->
                <div id="accountManagerSection" style="display: none;" class="mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Account Management</h5>
                            <p class="text-muted">Select which accounts to include in data collection</p>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllAccounts" onchange="toggleAllAccounts(this)">
                                    <label class="form-check-label" for="selectAllAccounts">
                                        Select All
                                    </label>
                                </div>
                            </div>

                            <div id="accountsList" style="max-height: 400px; overflow-y: auto;">
                                <!-- Accounts will be populated here -->
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="saveAccountSettings()">Save Changes</button>
                                <button class="btn btn-outline-secondary" onclick="hideAccountManager()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                // Add these functions for account management
                async function showAccountManager() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/available-accounts`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const accountsList = document.getElementById('accountsList');
                            accountsList.innerHTML = data.accounts.map(account => {
                                const statuses = [];
                                if (data.available_accounts.includes(account)) {
                                    statuses.push('<span class="badge bg-success">Available</span>');
                                }
                                if (data.db_accounts.includes(account)) {
                                    statuses.push('<span class="badge bg-info">Has Data</span>');
                                }
                                
                                return `
                                    <div class="d-flex align-items-center p-2 border-bottom">
                                        <div class="form-check flex-grow-1">
                                            <input class="form-check-input account-checkbox" 
                                                   type="checkbox" 
                                                   value="${account}" 
                                                   id="account_${account.replace(/\s+/g, '_')}"
                                                   ${data.enabled_accounts.includes(account) ? 'checked' : ''}>
                                            <label class="form-check-label" for="account_${account.replace(/\s+/g, '_')}">
                                                ${account}
                                            </label>
                                        </div>
                                        <div class="ms-2">
                                            ${statuses.join(' ')}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            document.getElementById('accountManagerSection').style.display = 'block';
                            
                            // Update select all checkbox state
                            const allCheckboxes = document.querySelectorAll('.account-checkbox');
                            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                            document.getElementById('selectAllAccounts').checked = allChecked;
                        } else {
                            console.error('Failed to get accounts:', data.error);
                            alert('Error loading accounts: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error loading accounts:', error);
                        alert('Error loading accounts: ' + error.message);
                    }
                }

                function hideAccountManager() {
                    document.getElementById('accountManagerSection').style.display = 'none';
                }

                function toggleAllAccounts(checkbox) {
                    const accountCheckboxes = document.querySelectorAll('.account-checkbox');
                    accountCheckboxes.forEach(box => box.checked = checkbox.checked);
                }

                async function saveAccountSettings() {
                    try {
                        const selectedAccounts = Array.from(document.querySelectorAll('.account-checkbox:checked'))
                            .map(checkbox => checkbox.value);
                        
                        const response = await fetch(`${API_BASE_URL}/api/update-enabled-accounts`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                accounts: selectedAccounts
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            alert('Account settings saved successfully!');
                            hideAccountManager();
                            // Refresh the client dropdown
                            await populateClientDropdown();
                        } else {
                            alert('Error saving account settings: ' + data.error);
                        }
                    } catch (error) {
                        alert('Error saving account settings: ' + error);
                    }
                }
                </script>

                <footer class="footer">
                    <a href="http://localhost:5001/admin/database" class="admin-link">
                        <i class="bi bi-gear"></i> Admin Interface
                    </a>
                </footer>
            </body>
            </html>
            
            