            <!DOCTYPE html>
            <html>
            <head>
                <title>Referral Analytics</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <style>
                    .positive { color: green; }
                    .negative { color: red; }
                    .table-container { margin-bottom: 2rem; }
                    .trends-panel {
                        position: fixed;
                        right: -500px;
                        top: 0;
                        width: 500px;
                        height: 100vh;
                        background: white;
                        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
                        transition: right 0.3s ease;
                        z-index: 1050;
                        padding: 20px;
                        overflow-y: auto;
                    }
                    .trends-panel.active { right: 0; }
                    .chart-container {
                        height: 300px !important;
                        position: relative;
                        margin-bottom: 40px;
                    }
                    
                    .chart-container canvas {
                        max-height: 100%;
                    }
                    
                    .chart-container h4 {
                        margin-bottom: 20px;
                    }
                    
                    .table-row-clickable:hover {
                        background-color: #f5f5f5;
                        cursor: pointer;
                    }
                    .metrics-summary {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }
                    
                    .metric {
                        margin-bottom: 10px;
                    }
                    
                    .metric label {
                        display: block;
                        font-size: 0.9em;
                        color: #666;
                    }
                    
                    .metric span {
                        font-size: 1.2em;
                        font-weight: bold;
                    }
                    .partnership-trends {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        margin-top: 20px;
                    }

                    .current-period .stats {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                        margin: 15px 0;
                    }

                    .relationship-summary {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        margin: 20px 0;
                    }

                    .trend-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                    }

                    .trend-direction {
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 0.9em;
                    }

                    .trend-direction.improving {
                        background: #e6ffe6;
                        color: #006600;
                    }

                    .trend-direction.declining {
                        background: #ffe6e6;
                        color: #660000;
                    }

                    /* Ensure tooltips appear above the panel */
                    .tooltip {
                        z-index: 1060 !important;
                    }
                    
                    /* Style the partner name header */
                    #partnerNameHeader {
                        font-size: 1.5rem;
                        margin: 0;
                        padding: 0;
                    }

                    .partner-name {
                        font-size: 1.75rem;
                        font-weight: 600;
                        margin: 0;
                        padding: 0;
                    }

                    .trends-panel {
                        padding: 20px;
                    }

                    /* Ensure tooltips are visible */
                    .tooltip {
                        z-index: 9999 !important;
                    }

                    .trends-panel h1 {
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                    }
                    
                    .trends-panel .partner-name {
                        font-size: 1.5rem;
                        color: #666;
                        margin-top: 0;
                    }

                    .panel-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 2rem;
                    }

                    .title-section h1 {
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                    }

                    .title-section .partner-name {
                        font-size: 1.25rem;
                        color: #666;
                        margin-top: 0;
                    }

                    /* Style the info icons */
                    .bi-info-circle {
                        font-size: 0.9em;
                        color: #6c757d;
                        cursor: help;
                        margin-left: 4px;
                    }

                    .card-body h6 {
                        font-size: 0.9rem;
                        color: #666;
                        margin-bottom: 1rem;
                    }
                    
                    .growth-item {
                        margin-bottom: 0.5rem;
                    }
                    
                    .growth-item .partner-name {
                        font-size: 0.85rem;
                        color: #333;
                        margin-bottom: 0.1rem;
                    }
                    
                    .growth-item .growth-value {
                        font-size: 0.8rem;
                        font-weight: 500;
                    }
                    
                    .growth-value.positive {
                        color: #28a745;
                    }
                    
                    .growth-value.negative {
                        color: #dc3545;
                    }
                    .growth-value-container {
                        display: flex;
                        align-items: baseline;
                        gap: 4px;
                    }
                    
                    .period-label {
                        font-size: 0.7rem;
                        color: #666;
                        font-weight: normal;
                    }
                    
                    .show-more-button {
                        margin: 1rem 0 3rem 0;
                        color: #6c757d;
                        text-decoration: none;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        padding: 0.5rem 1rem;
                        border: 1px solid #dee2e6;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }
                    
                    .show-more-button:hover {
                        background-color: #f8f9fa;
                        color: #495057;
                    }
                    
                    .show-more-button i {
                        transition: transform 0.2s ease;
                    }
                    
                    .show-more-button[aria-expanded="true"] i {
                        transform: rotate(180deg);
                    }
                    
                    /* Add more bottom margin to the container */
                    .container {
                        margin-bottom: 5rem;
                    }
                </style>
            </head>
            <body>
                <div class="container mt-4">
                    <h2 class="mb-4">Referral Analytics</h2>
                    
                    <!-- Add Client and Date Selectors -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientSelect">Client</label>
                                <select class="form-select" id="clientSelect">
                                    <option value="all">All Clients</option>
<option value="ATH Media LLC">ATH Media LLC</option>
<option value="Adam Graham">Adam Graham</option>
<option value="Chris Donnelly">Chris Donnelly</option>
<option value="ConvertKit">ConvertKit</option>
<option value="Eric Partaker">Eric Partaker</option>
<option value="Good Good Good">Good Good Good</option>
<option value="Life's A Game with Amanda Goetz">Life's A Game with Amanda Goetz</option>
<option value="Micro-Agency Launchpad">Micro-Agency Launchpad</option>
<option value="Nathan Barry">Nathan Barry</option>
<option value="The Perfect Loaf">The Perfect Loaf</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dateRangeSelect">Date Range</label>
                                <select class="form-select" id="dateRangeSelect">
                                    <option value="1">24 hours</option>
                                    <option value="7">7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30" selected>30 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Add this after the date selector, before the table -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Partnership Health</h5>
                                    <div class="d-flex justify-content-between">
                                        <div class="metric">
                                            <label>Improving</label>
                                            <span class="value positive">0</span>
                                        </div>
                                        <div class="metric">
                                            <label>Declining</label>
                                            <span class="value negative">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Fastest Growing</h6>
                                            <div class="fastest-growing">
                                                <!-- Will be populated dynamically -->
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Fastest Declining</h6>
                                            <div class="fastest-declining">
                                                <!-- Will be populated dynamically -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add this after your existing cards, before the table -->
                    <div class="mb-4">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manualEntryModal">
                            <i class="bi bi-plus-circle"></i> Add Manual Referrals
                        </button>
                    </div>

                    <div id="defaultDashboard">
                        <h3 class="mb-4">Largest Referral Imbalances</h3>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Received</th>
                                        <th>Sent</th>
                                        <th>Balance</th>
                                        <th>All-Time Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="activePartners">
                                    <!-- Active partners will go here -->
                                </tbody>
                                
                                <tbody id="inactivePartnersSection" class="collapse">
                                    <!-- Inactive partners will go here -->
                                </tbody>
                            </table>
                            
                            <button class="show-more-button" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#inactivePartnersSection" 
                                    aria-expanded="false">
                                <span class="button-text">Show inactive partners</span>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trends Panel -->
                <div id="trendsPanel" class="trends-panel">
                    <div class="panel-header">
                        <div class="title-section">
                            <h1>Partnership Trends</h1>
                            <h2 id="partnerName" class="partner-name"></h2>
                        </div>
                        <button type="button" class="btn-close" onclick="closeTrendsPanel()"></button>
                    </div>
                    
                   
                    <div class="current-period">
                        <h4>Current Period</h4>
                        <div class="metrics-summary">
                            <div class="metric">
                                <label>Received</label>
                                <span id="receivedMetric">0</span>
                            </div>
                            <div class="metric">
                                <label>Sent</label>
                                <span id="sentMetric">0</span>
                            </div>
                            <div class="metric">
                                <label>Balance</label>
                                <span id="balanceMetric">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trend-metrics mt-4">
                        <h4>Growth Metrics</h4>
                        <div class="metrics-summary">
                            <div class="metric">
                                <label>
                                    Daily Change 
                                    <i class="bi bi-info-circle" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="left" 
                                       title="The average number of new subscribers gained or lost per day during the selected period. A positive number (154.5) means you're gaining an average of 154.5 subscribers each day."></i>
                                </label>
                                <span id="dailyChangeMetric"></span>
                            </div>
                            <div class="metric">
                                <label>
                                    Growth Rate 
                                    <i class="bi bi-info-circle" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="left" 
                                       title="The percentage increase or decrease in total subscribers over the selected period. A rate of 3.3% means your subscriber count has grown by 3.3% since the start of the period."></i>
                                </label>
                                <span id="growthRateMetric"></span>
                            </div>
                            <div class="metric">
                                <label>
                                    Trend 
                                    <i class="bi bi-info-circle" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="left" 
                                       title="The overall direction of the partnership. 'Improving' means you're receiving more subscribers than you're sending, 'Declining' means you're sending more than receiving, and 'Stable' means the exchange is roughly equal."></i>
                                </label>
                                <span id="trendMetric"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container mt-4 mb-5" style="height: 300px; position: relative;">
                        <h4>Historical Trend</h4>
                        <canvas id="trendChart"></canvas>
                    </div>

                    <!-- Add significant margin between charts -->
                    <div style="margin: 60px 0;"></div>

                    <div class="chart-container mt-5" style="height: 300px; position: relative;">
                        <h4>Daily Changes</h4>
                        <canvas id="dailyTrendChart"></canvas>
                    </div>
                </div>

                <script>
                    let exchangeChart = null;
                    let currentSort = { column: 'balance', direction: 'desc' };
                    let tableData = [];

                    function formatNumber(num) {
                        return new Intl.NumberFormat().format(num);
                    }
                    
                    function showTrendsPanel(received, sent, balance, partner) {
                        console.log('showTrendsPanel called with:', { received, sent, balance, partner });
                        
                        document.getElementById('partnerName').textContent = partner;
                        
                        const panel = document.getElementById('trendsPanel');
                        panel.classList.add('active');
                        
                        // Get current client and date range
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate dates
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        const url = `http://localhost:5001/api/partnership-trends?account=${encodeURIComponent(client)}&partner=${encodeURIComponent(partner)}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}&t=${Date.now()}`;
                        console.log('Fetching from URL:', url);
                        
                        fetch(url)
                            .then(response => {
                                console.log('Response status:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Received trend data:', data);
                                
                                // Update current metrics
                                document.getElementById('receivedMetric').textContent = received.toLocaleString();
                                document.getElementById('sentMetric').textContent = sent.toLocaleString();
                                document.getElementById('balanceMetric').textContent = balance.toLocaleString();
                                
                                // Update growth metrics
                                if (data.growth) {
                                    document.getElementById('dailyChangeMetric').textContent = 
                                        data.growth.daily_change.toLocaleString();
                                    document.getElementById('growthRateMetric').textContent = 
                                        `${data.growth.growth_rate.toLocaleString()}%`;
                                    document.getElementById('trendMetric').textContent = 
                                        data.growth.trend_direction;
                                }
                                
                                // Update trend chart if we have historical data
                                if (data.historical_data) {
                                    updateTrendChart(data.historical_data);
                                }
                                
                                // Destroy existing tooltips
                                const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                                tooltips.forEach(el => {
                                    const tooltip = bootstrap.Tooltip.getInstance(el);
                                    if (tooltip) {
                                        tooltip.dispose();
                                    }
                                });
                                
                                // Initialize new tooltips
                                tooltips.forEach(el => {
                                    new bootstrap.Tooltip(el, {
                                        container: 'body',
                                        placement: 'left',
                                        trigger: 'hover'
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching trends:', error);
                            });
                    }

                    function closeTrendsPanel() {
                        const panel = document.getElementById('trendsPanel');
                        panel.classList.remove('active');
                    }

                    function updateTrendChart(historicalData) {
                        console.log('Updating charts with data:', historicalData);
                        
                        // Historical Trend Chart
                        const ctx = document.getElementById('trendChart');
                        if (!ctx) {
                            console.error('Trend chart canvas not found');
                            return;
                        }

                        // Clear any existing chart
                        const existingChart = Chart.getChart(ctx);
                        if (existingChart) {
                            existingChart.destroy();
                        }

                        // Create historical trend chart
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: historicalData.dates,
                                datasets: [{
                                    label: 'Received',
                                    data: historicalData.received,
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1
                                }, {
                                    label: 'Sent',
                                    data: historicalData.sent,
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: Math.max(...historicalData.received, ...historicalData.sent) * 1.1,
                                        grid: {
                                            drawBorder: false
                                        }
                                    },
                                    x: {
                                        grid: {
                                            drawBorder: false
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    }
                                }
                            }
                        });

                        // Daily Changes Chart
                        const dailyCtx = document.getElementById('dailyTrendChart');
                        if (!dailyCtx) {
                            console.error('Daily trend chart canvas not found');
                            return;
                        }

                        // Clear any existing daily chart
                        const existingDailyChart = Chart.getChart(dailyCtx);
                        if (existingDailyChart) {
                            existingDailyChart.destroy();
                        }

                        // Calculate daily changes
                        const dailyReceived = [];
                        const dailySent = [];
                        
                        for (let i = 1; i < historicalData.received.length; i++) {
                            dailyReceived.push(historicalData.received[i] - historicalData.received[i-1]);
                            dailySent.push(historicalData.sent[i] - historicalData.sent[i-1]);
                        }

                        // Create daily changes chart
                        new Chart(dailyCtx, {
                            type: 'line',
                            data: {
                                labels: historicalData.dates.slice(1),
                                datasets: [{
                                    label: 'Daily Received',
                                    data: dailyReceived,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }, {
                                    label: 'Daily Sent',
                                    data: dailySent,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: Math.max(...dailyReceived, ...dailySent) * 1.1,
                                        grid: {
                                            drawBorder: false
                                        }
                                    },
                                    x: {
                                        grid: {
                                            drawBorder: false
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                elements: {
                                    point: {
                                        radius: 4,
                                        hoverRadius: 6
                                    },
                                    line: {
                                        borderWidth: 2
                                    }
                                }
                            }
                        });
                    }

                    function formatBalanceValue(value) {
                        if (isNaN(value)) value = 0;
                        const cls = value >= 0 ? 'positive' : 'negative';
                        return `<span class="${cls}">${value.toLocaleString()}</span>`;
                    }

                    // Add to the script section
                    // Initialize date inputs
                    document.addEventListener('DOMContentLoaded', function() {
                        // Clear any existing data
                        tableData = [];
                        
                        // Clear any existing charts
                        const ctx = document.getElementById('trendChart');
                        if (ctx) {
                            const existingChart = Chart.getChart(ctx);
                            if (existingChart) {
                                existingChart.destroy();
                            }
                        }
                        
                        // Then load fresh data
                        loadDefaultDashboard();
                        // ... rest of your existing code ...
                    });

                    function refreshData() {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const client = document.getElementById('clientSelect').value;
                        
                        console.log('Refreshing data for:', {
                            dateRange,
                            client
                        });
                        // TODO: Add API call to refresh data
                    }

                    // Add these function definitions before your event listeners
                    let imbalances = [];

                    function formatDate(date) {
                        return date.toISOString().split('T')[0];  // Returns YYYY-MM-DD format
                    }

                    function loadDefaultDashboard() {
                        console.log('Loading dashboard...');
                        
                        // Get selected date range
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date(end);
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        const startStr = formatDate(start);
                        const endStr = formatDate(end);
                        
                        const url = `http://localhost:5001/api/largest-imbalances?start=${startStr}&end=${endStr}`;
                        
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Update table data
                                tableData = data;
                                
                                // Sort by balance (negative first)
                                sortTable('balance');
                                
                                renderTable();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.getElementById('imbalancesTableBody').innerHTML = 
                                    `<tr><td colspan="5" class="text-center">Error loading data: ${error.message}</td></tr>`;
                            });
                    }

                    function sortTable(column) {
                        const direction = currentSort.column === column && currentSort.direction === 'desc' ? 'asc' : 'desc';
                        
                        tableData.sort((a, b) => {
                            let valueA, valueB;
                            
                            switch(column) {
                                case 'partner':
                                    valueA = a.partner || '';
                                    valueB = b.partner || '';
                                    return direction === 'desc' ? valueB.localeCompare(valueA) : valueA.localeCompare(valueB);
                                case 'received':
                                    valueA = a.period_received || a.received || 0;
                                    valueB = b.period_received || b.received || 0;
                                    break;
                                case 'sent':
                                    valueA = a.period_sent || a.sent || 0;
                                    valueB = b.period_sent || b.sent || 0;
                                    break;
                                case 'balance':
                                    valueA = a.period_balance || a.imbalance || 0;
                                    valueB = b.period_balance || b.imbalance || 0;
                                    break;
                            }
                            
                            return direction === 'desc' ? valueA - valueB : valueB - valueA;
                        });
                        
                        currentSort = { column, direction };
                        renderTable();
                    }

                    function updateTableHeaders() {
                        const isDefaultView = document.getElementById('clientSelect').value === 'all';
                        const thead = document.querySelector('table thead tr');
                        
                        thead.innerHTML = isDefaultView ? `
                            <th onclick="sortTable('partner')" style="cursor: pointer;">Partner</th>
                            <th onclick="sortTable('account')" style="cursor: pointer;">Client</th>
                            <th onclick="sortTable('received')" style="cursor: pointer;">Received</th>
                            <th onclick="sortTable('sent')" style="cursor: pointer;">Sent</th>
                            <th onclick="sortTable('balance')" style="cursor: pointer;">Balance</th>
                            <th onclick="sortTable('balance')" style="cursor: pointer;">All-Time Balance</th>
                        ` : `
                            <th onclick="sortTable('partner')" style="cursor: pointer;">Partner</th>
                            <th onclick="sortTable('received')" style="cursor: pointer;">Received</th>
                            <th onclick="sortTable('sent')" style="cursor: pointer;">Sent</th>
                            <th onclick="sortTable('balance')" style="cursor: pointer;">Balance</th>
                            <th onclick="sortTable('balance')" style="cursor: pointer;">All-Time Balance</th>
                        `;
                    }

                    function renderTable() {
                        const tbody = document.querySelector('#activePartners');
                        const inactiveTbody = document.querySelector('#inactivePartnersSection');
                        tbody.innerHTML = '';
                        inactiveTbody.innerHTML = '';
                        
                        const isDefaultView = document.getElementById('clientSelect').value === 'all';
                        
                        // Split data into active and inactive partners
                        const activePartners = tableData.filter(item => 
                            item.period_received > 0 || item.period_sent > 0 || item.all_time_balance !== 0
                        );
                        
                        const inactivePartners = tableData.filter(item => 
                            item.period_received === 0 && item.period_sent === 0 && item.all_time_balance === 0
                        );
                        
                        // Render active partners
                        activePartners.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'table-row-clickable';
                            const periodBalanceClass = (item.period_balance || 0) >= 0 ? 'positive' : 'negative';
                            const allTimeBalanceClass = (item.all_time_balance || 0) >= 0 ? 'positive' : 'negative';
                            
                            row.innerHTML = isDefaultView ? `
                                <td>${item.partner}</td>
                                <td>${item.account || ''}</td>
                                <td>${(item.period_received || 0).toLocaleString()}</td>
                                <td>${(item.period_sent || 0).toLocaleString()}</td>
                                <td class="${periodBalanceClass}">${(item.period_balance || 0).toLocaleString()}</td>
                                <td class="${allTimeBalanceClass}">${(item.all_time_balance || 0).toLocaleString()}</td>
                            ` : `
                                <td>${item.partner}</td>
                                <td>${(item.period_received || 0).toLocaleString()}</td>
                                <td>${(item.period_sent || 0).toLocaleString()}</td>
                                <td class="${periodBalanceClass}">${(item.period_balance || 0).toLocaleString()}</td>
                                <td class="${allTimeBalanceClass}">${(item.all_time_balance || 0).toLocaleString()}</td>
                            `;
                            
                            row.onclick = () => showTrendsPanel(
                                item.period_received || 0,
                                item.period_sent || 0,
                                item.period_balance || 0,
                                item.partner
                            );
                            
                            tbody.appendChild(row);
                        });
                        
                        // Render inactive partners
                        inactivePartners.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'table-row-clickable';
                            row.innerHTML = isDefaultView ? `
                                <td>${item.partner}</td>
                                <td>${item.account || ''}</td>
                                <td>0</td>
                                <td>0</td>
                                <td>0</td>
                                <td>0</td>
                            ` : `
                                <td>${item.partner}</td>
                                <td>0</td>
                                <td>0</td>
                                <td>0</td>
                                <td>0</td>
                            `;
                            
                            row.onclick = () => showTrendsPanel(0, 0, 0, item.partner);
                            inactiveTbody.appendChild(row);
                        });
                        
                        // Set initial button text
                        const showMoreButton = document.querySelector('.show-more-button .button-text');
                        if (showMoreButton) {
                            const inactiveCount = inactivePartners.length;
                            const isExpanded = document.getElementById('inactivePartnersSection').classList.contains('show');
                            if (isExpanded) {
                                buttonText.textContent = `Show ${inactiveCount} inactive partners`;
                            } else {
                                buttonText.textContent = 'Hide inactive partners';
                            }
                        }
                    }

                    function updateTable(data) {
                        tableData = data;
                        sortTable('balance'); // Default sort by balance
                    }

                    // Your existing event listener code remains the same
                    document.addEventListener('DOMContentLoaded', function() {
                        // Initial load of default dashboard
                        loadDefaultDashboard();

                        // Add event listeners for selectors
                        document.getElementById('clientSelect').addEventListener('change', function() {
                            console.log('Client changed:', this.value);
                            closeTrendsPanel();
                            
                            const selectedClient = this.value;
                            const selectedDays = document.getElementById('dateRangeSelect').value;
                            
                            // Calculate date range
                            const end = new Date();
                            const start = new Date();
                            start.setDate(start.getDate() - parseInt(selectedDays));
                            
                            if (selectedClient === 'all') {
                                loadDefaultDashboard();
                            } else {
                                const url = new URL('http://localhost:5001/api/partnership-metrics');
                                url.searchParams.append('account', selectedClient);
                                url.searchParams.append('start', start.toISOString().split('T')[0]);
                                url.searchParams.append('end', end.toISOString().split('T')[0]);
                                
                                console.log('Fetching from URL:', url.toString());
                                
                                fetch(url, {
                                    method: 'GET',
                                    mode: 'cors',
                                    credentials: 'include',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json',
                                        'Cache-Control': 'no-cache'
                                    }
                                })
                                .then(response => {
                                    console.log('Response status:', response.status);
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Received data:', data);
                                    updateTable(data);
                                    updateDashboardMetrics(data);
                                    sortTable('balance');
                                })
                                .catch(error => console.error('Error:', error));
                            }
                        });

                        document.getElementById('dateRangeSelect').addEventListener('change', function() {
                            // Close the trends panel when changing date range
                            closeTrendsPanel();
                            
                            const selectedClient = document.getElementById('clientSelect').value;
                            const dateRange = this.value;
                            
                            // Calculate dates
                            const end = new Date();
                            const start = new Date();
                            start.setDate(end.getDate() - parseInt(dateRange));
                            
                            if (selectedClient === 'all') {
                                loadDefaultDashboard();
                            } else {
                                // Use partnership-metrics endpoint for specific client
                                fetch(`http://localhost:5001/api/partnership-metrics?` + 
                                    `account=${encodeURIComponent(selectedClient)}&` +
                                    `start=${start.toISOString().split('T')[0]}&` +
                                    `end=${end.toISOString().split('T')[0]}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        // Update table data and maintain sort
                                        tableData = data.sort((a, b) => {
                                            const balanceA = a.period_balance || 0;
                                            const balanceB = b.period_balance || 0;
                                            return balanceA - balanceB; // This puts negative numbers first
                                        });
                                        renderTable();
                                    })
                                    .catch(error => console.error('Error:', error));
                            }
                        });
                    });

                    // Add this function to fetch trends
                    async function fetchPartnershipTrends() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate start and end dates based on selected range
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        const startStr = start.toISOString().split('T')[0];
                        const endStr = end.toISOString().split('T')[0];
                        
                        try {
                            const response = await fetch(`http://localhost:5001/api/partnership-trends?account=${client}&start=${startStr}&end=${endStr}`);
                            const trends = await response.json();
                            
                            // Update the trends panel
                            updateTrendsPanel(trends);
                        } catch (error) {
                            console.error('Error fetching partnership trends:', error);
                        }
                    }

                    // Add this function to update the UI
                    function updateTrendsPanel(trends) {
                        const trendsPanel = document.querySelector('.partnership-trends');
                        if (!trendsPanel) {
                            // Create the panel if it doesn't exist
                            createTrendsPanel();
                        }
                        
                        // Update current period stats
                        document.getElementById('received-trend').textContent = trends.overall.received.end_total;
                        document.getElementById('sent-trend').textContent = trends.overall.sent.end_total;
                        document.getElementById('balance-trend').textContent = 
                            trends.overall.received.end_total - trends.overall.sent.end_total;
                        
                        // Update summary stats
                        document.getElementById('improving-relationships').textContent = 
                            trends.summary.improving_relationships;
                        document.getElementById('declining-relationships').textContent = 
                            trends.summary.declining_relationships;
                        
                        // Update fastest growing partners
                        const trendsList = document.getElementById('trends-list');
                        trendsList.innerHTML = trends.partner_trends
                            .slice(0, 5)  // Show top 5
                            .map(partner => `
                                <div class="trend-item">
                                    <div class="partner-name">${partner.partner}</div>
                                    <div class="trend-stats">
                                        <div>Growth: ${partner.growth.growth_rate}%</div>
                                        <div>Daily Change: ${partner.growth.daily_change}</div>
                                        <div class="trend-direction ${partner.growth.trend_direction.toLowerCase()}">
                                            ${partner.growth.trend_direction}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                    }

                    // Add this function to create the trends panel
                    function createTrendsPanel() {
                        const panel = document.createElement('div');
                        panel.className = 'partnership-trends';
                        panel.innerHTML = `
                            <h2>Partnership Trends</h2>
                            <div class="current-period">
                                <h3>Current Period</h3>
                                <div class="stats">
                                    <div>
                                        <label>Received</label>
                                        <span id="received-trend">0</span>
                                    </div>
                                    <div>
                                        <label>Sent</label>
                                        <span id="sent-trend">0</span>
                                    </div>
                                    <div>
                                        <label>Balance</label>
                                        <span id="balance-trend">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="relationship-summary">
                                <div>
                                    <label>Improving Relationships</label>
                                    <span id="improving-relationships">0</span>
                                </div>
                                <div>
                                    <label>Declining Relationships</label>
                                    <span id="declining-relationships">0</span>
                                </div>
                            </div>
                            <div class="fastest-growing">
                                <h3>Fastest Growing Partnerships</h3>
                                <div id="trends-list"></div>
                            </div>
                        `;
                        
                        document.querySelector('.container').appendChild(panel);
                    }

                    // Update the existing loadData function to include trends
                    async function loadData() {
                        await Promise.all([
                            fetchImbalances(),
                            updateDashboardTrends()
                        ]);
                    }

                    // Add function to update dashboard trends
                    function updateDashboardTrends() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate dates
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        fetch(`http://localhost:5001/api/overall-trends?account=${encodeURIComponent(client)}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`)
                            .then(response => response.json())
                            .then(data => {
                                // Update improving/declining counts
                                document.getElementById('improving-relationships').textContent = 
                                    data.summary.improving_relationships;
                                document.getElementById('declining-relationships').textContent = 
                                    data.summary.declining_relationships;
                                
                                // Update fastest growing list
                                const trendsList = document.getElementById('trends-list');
                                trendsList.innerHTML = data.fastest_growing
                                    .map(partner => `
                                        <div class="trend-item">
                                            <div class="partner-name">${partner.name}</div>
                                            <div class="trend-stats">
                                                <div>Growth: ${partner.growth_rate}%</div>
                                                <div class="trend-direction ${partner.trend_direction.toLowerCase()}">
                                                    ${partner.trend_direction}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('');
                            })
                            .catch(error => console.error('Error:', error));
                    }

                    // Initialize all tooltips
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl)
                    })

                    function updateTooltips(startDate, endDate, partnerName) {
                        // Format dates for display
                        const formatDate = (date) => {
                            return new Date(date).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            });
                        };
                        
                        const period = `${formatDate(startDate)} to ${formatDate(endDate)}`;
                        
                        // Update tooltip text
                        const dailyChangeTooltip = document.getElementById('dailyChangeTooltip');
                        const growthRateTooltip = document.getElementById('growthRateTooltip');
                        const trendTooltip = document.getElementById('trendTooltip');
                        
                        dailyChangeTooltip.setAttribute('title', 
                            `The average number of subscribers gained or lost per day from ${period}`);
                        growthRateTooltip.setAttribute('title', 
                            `Percentage increase or decrease in subscribers from ${period}`);
                        trendTooltip.setAttribute('title', 
                            `Overall direction of subscriber growth from ${period}`);
                        
                        // Make sure to destroy and reinitialize tooltips
                        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                        tooltips.forEach(el => {
                            const tooltip = bootstrap.Tooltip.getInstance(el);
                            if (tooltip) {
                                tooltip.dispose();
                            }
                            new bootstrap.Tooltip(el, {
                                container: 'body',
                                placement: 'left'
                            });
                        });
                    }
                    
                    // Call this function whenever you update your data
                    // For example, in your loadData() function:
                    async function loadData() {
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        updateTooltips(start, end);
                        
                        // ... rest of your loadData function
                    }

                    function showPartnerTrends(creator) {
                        const panel = document.querySelector('.trends-panel');
                        // Set the partner name
                        document.getElementById('partnerName').textContent = creator;
                        
                        // Show the panel
                        panel.classList.add('active');
                        
                        console.log('Setting partner name to:', creator); // Debug log
                    }

                    // Wherever you handle the click to open the panel
                    function onPartnerClick(creator) {
                        console.log('Opening panel for:', creator);
                        showPartnerTrends(creator);
                    }

                    async function fetchImbalances() {
                        const client = document.getElementById('clientSelect').value;
                        const dateRange = document.getElementById('dateRangeSelect').value;
                        
                        // Calculate dates
                        const end = new Date();
                        const start = new Date();
                        start.setDate(end.getDate() - parseInt(dateRange));
                        
                        try {
                            const response = await fetch(
                                `http://localhost:5001/api/partnership-metrics?` + 
                                `account=${encodeURIComponent(client)}&` +
                                `start=${start.toISOString().split('T')[0]}&` +
                                `end=${end.toISOString().split('T')[0]}`
                            );
                            
                            const data = await response.json();
                            
                            // Update dashboard metrics first
                            await updateDashboardMetrics(data);
                            
                            
                            // Then update table
                            tableData = data.sort((a, b) => {
                                const balanceA = a.period_balance || 0;
                                const balanceB = b.period_balance || 0;
                                return balanceA - balanceB;
                            });
                            
                            renderTable();
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }

                    async function updateDashboardMetrics(data) {
                        console.log('Updating dashboard metrics with data:', data);
                        
                        // Calculate Partnership Health
                        const improving = data.filter(p => p.period_balance > 0).length;
                        const declining = data.filter(p => p.period_balance < 0).length;
                        
                        console.log('Partnership Health metrics:', { improving, declining });
                        
                        // Update Partnership Health display
                        const improvingElement = document.querySelector('.metric:nth-child(1) .value');
                        const decliningElement = document.querySelector('.metric:nth-child(2) .value');
                        
                        if (improvingElement && decliningElement) {
                            improvingElement.textContent = improving;
                            decliningElement.textContent = declining;
                        } else {
                            console.error('Could not find Partnership Health elements');
                        }
                        
                        // Calculate Fastest Growing and Declining
                        const fastestGrowing = [...data]
                            .sort((a, b) => b.period_balance - a.period_balance)
                            .slice(0, 3)  // Get top 3
                            .filter(p => p.period_balance > 0);  // Only positive growth
                            
                        const fastestDeclining = [...data]
                            .sort((a, b) => a.period_balance - b.period_balance)
                            .slice(0, 3)  // Get top 3
                            .filter(p => p.period_balance < 0);  // Only negative growth
                            
                        console.log('Fastest Growing partners:', fastestGrowing);
                        console.log('Fastest Declining partners:', fastestDeclining);
                        
                        // Update Fastest Growing section
                        const fastestGrowingContainer = document.querySelector('.fastest-growing');
                        const fastestDecliningContainer = document.querySelector('.fastest-declining');
                        
                        if (fastestGrowingContainer) {
                            const fastestGrowingHtml = fastestGrowing
                                .map(partner => `
                                    <div class="growth-item">
                                        <div class="partner-name">${partner.partner}</div>
                                        <div class="growth-value-container">
                                            <span class="growth-value positive">+${partner.period_balance.toLocaleString()}</span>
                                            <span class="period-label">last ${document.getElementById('dateRangeSelect').value} days</span>
                                        </div>
                                    </div>
                                `)
                                .join('');
                            
                            fastestGrowingContainer.innerHTML = fastestGrowingHtml;
                        }
                        
                        if (fastestDecliningContainer) {
                            const fastestDecliningHtml = fastestDeclining
                                .map(partner => `
                                    <div class="growth-item">
                                        <div class="partner-name">${partner.partner}</div>
                                        <div class="growth-value-container">
                                            <span class="growth-value negative">${partner.period_balance.toLocaleString()}</span>
                                            <span class="period-label">last ${document.getElementById('dateRangeSelect').value} days</span>
                                        </div>
                                    </div>
                                `)
                                .join('');
                            
                            fastestDecliningContainer.innerHTML = fastestDecliningHtml;
                        }
                    }

                    // Function to populate the partner dropdown based on current client
                    function populatePartnerDropdown() {
                        const currentClient = document.getElementById('clientSelect').value;
                        const partnerSelect = document.getElementById('manualPartner');
                        
                        console.log('Populating partners for client:', currentClient);
                        
                        // Clear existing options
                        partnerSelect.innerHTML = '<option value="">Select a partner...</option>';
                        
                        // Get partners from the table data instead of making an API call
                        const partners = Array.from(document.querySelectorAll('#defaultDashboard table tbody tr'))
                            .map(row => row.cells[0].textContent.trim());
                        
                        console.log('Found partners:', partners);
                        
                        // Add partners to dropdown
                        partners.forEach(partner => {
                            const option = document.createElement('option');
                            option.value = partner;
                            option.textContent = partner;
                            partnerSelect.appendChild(option);
                        });
                    }

                    // Update the modal show event to populate partners
                    document.addEventListener('DOMContentLoaded', function() {
                        const manualEntryModal = document.getElementById('manualEntryModal');
                        if (manualEntryModal) {
                            manualEntryModal.addEventListener('show.bs.modal', function (event) {
                                populatePartnerDropdown();
                                // Set today's date as default
                                document.getElementById('manualDate').valueAsDate = new Date();
                            });
                        }
                    });

                    function submitManualEntry() {
                        const partner = document.getElementById('manualPartner').value;
                        const date = document.getElementById('manualDate').value;
                        const received = document.getElementById('manualReceived').value;
                        const sent = document.getElementById('manualSent').value;
                        const notes = document.getElementById('manualNotes').value;

                        // Validate that at least one of received or sent has a value
                        if (!received && !sent) {
                            alert('Please enter either a Received or Sent value');
                            return;
                        }

                        const formData = {
                            partner: partner,
                            date: date,
                            received: received ? parseInt(received) : null,  // Only include if has value
                            sent: sent ? parseInt(sent) : null,  // Only include if has value
                            notes: notes
                        };

                        fetch('http://localhost:5001/api/manual-referrals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Close modal and refresh data
                            bootstrap.Modal.getInstance(document.getElementById('manualEntryModal')).hide();
                            refreshData();
                            
                            // Show success message
                            alert('Manual referral data added successfully!');
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error adding manual referral data');
                        });
                    }

                    function renderDashboardTable(data) {
                        console.log('Raw data received:', data);  // Log the initial data
                        
                        // Sort data to show active partners first
                        const activePartners = data.filter(row => {
                            const isActive = row.period_received !== 0 || row.period_sent !== 0 || row.all_time_balance !== 0;
                            console.log(`Partner ${row.partner}: active=${isActive}`, {
                                period_received: row.period_received,
                                period_sent: row.period_sent,
                                all_time_balance: row.all_time_balance
                            });
                            return isActive;
                        });
                        
                        const inactivePartners = data.filter(row => 
                            row.period_received === 0 && row.period_sent === 0 && row.all_time_balance === 0
                        );

                        console.log('Active partners:', activePartners);
                        console.log('Inactive partners:', inactivePartners);

                        let tableHtml = `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Received</th>
                                        <th>Sent</th>
                                        <th>Balance</th>
                                        <th>All-Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${activePartners.map(row => {
                                        console.log('Rendering active row:', row);
                                        return renderTableRow(row);
                                    }).join('')}
                                </tbody>
                                <tbody id="inactivePartners" class="collapse">
                                    ${inactivePartners.map(row => {
                                        console.log('Rendering inactive row:', row);
                                        return renderTableRow(row);
                                    }).join('')}
                                </tbody>
                            </table>
                            ${inactivePartners.length > 0 ? `
                                <button class="btn btn-link" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#inactivePartners"
                                        aria-expanded="false">
                                    Show ${inactivePartners.length} inactive partners
                                </button>
                            ` : ''}
                        `;

                        document.getElementById('defaultDashboard').innerHTML = tableHtml;
                    }

                    function renderTableRow(row) {
                        return `
                            <tr>
                                <td>${row.partner}</td>
                                <td>${row.period_received}</td>
                                <td>${row.period_sent}</td>
                                <td class="${row.period_balance > 0 ? 'text-success' : 'text-danger'}">
                                    ${row.period_balance}
                                </td>
                                <td class="${row.all_time_balance > 0 ? 'text-success' : 'text-danger'}">
                                    ${row.all_time_balance}
                                </td>
                            </tr>
                        `;
                    }

                    // Add event listener for the show/hide button
                    document.addEventListener('DOMContentLoaded', function() {
                        const showMoreButton = document.querySelector('.show-more-button');
                        const inactiveSection = document.getElementById('inactivePartnersSection');
                        
                        if (showMoreButton && inactiveSection) {
                            inactiveSection.addEventListener('show.bs.collapse', function() {
                                const buttonText = showMoreButton.querySelector('.button-text');
                                buttonText.textContent = 'Hide inactive partners';
                            });

                            inactiveSection.addEventListener('hide.bs.collapse', function() {
                                const buttonText = showMoreButton.querySelector('.button-text');
                                const inactiveCount = document.querySelectorAll('#inactivePartnersSection tr').length;
                                buttonText.textContent = `Show ${inactiveCount} inactive partners`;
                            });
                        }
                    });
                </script>

                <!-- Add this at the end of the body -->
                <div class="modal fade" id="manualEntryModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Manual Referral Data</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="manualEntryForm">
                                    <div class="mb-3">
                                        <label class="form-label">Partner</label>
                                        <select class="form-select" id="manualPartner" required>
                                            <option value="">Select a partner...</option>
                                            <!-- Will be populated with current client's partners -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="manualDate" required>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="mb-3">
                                                <label class="form-label">Received</label>
                                                <input type="number" class="form-control" id="manualReceived" 
                                                       placeholder="Optional">
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="mb-3">
                                                <label class="form-label">Sent</label>
                                                <input type="number" class="form-control" id="manualSent" 
                                                       placeholder="Optional">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" id="manualNotes" rows="2" 
                                                placeholder="e.g., Data from external tool"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitManualEntry()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
            